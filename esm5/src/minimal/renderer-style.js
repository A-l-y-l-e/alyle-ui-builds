import * as tslib_1 from "tslib";
import { Injectable, ElementRef, Renderer2, Optional } from '@angular/core';
import { LyTheme2, ThemeRef } from '../theme/theme2.service';
import { TypeStyle } from '../theme/style';
var __CLASS_NAME__ = '__CLASS_NAME__';
var StyleRenderer = /** @class */ (function () {
    function StyleRenderer(_theme, _el, _renderer) {
        this._theme = _theme;
        this._renderer = _renderer;
        this._set = new Set();
        if (_el) {
            this._nEl = _el.nativeElement;
            this._set = new Set();
        }
    }
    /**
     * Build multiple styles and render them in the DOM.
     * @param styles Styles
     * @param applyRootClass If `applyToRoot` is `true` and the root property is defined,
     * it will automatically be added to the component.
     *
     * e.g.
     *
     * ```ts
     * const STYLES = () => ({
     *   root: lyl `{...}` // this class will be added to the root component
     * })
     * ```
     *
     */
    StyleRenderer.prototype.renderSheet = function (styles, applyRootClass) {
        var classes = this._theme._createStyleContent2(styles, null, null, TypeStyle.Multiple);
        if (applyRootClass && classes.root) {
            this.addClass(classes.root);
        }
        return classes;
    };
    /**
     * Render style and apply class name to host Component or Directive,
     * require provide `StyleRenderer` in your Component.
     * e.g.
     * @Component({
     *   ...
     *   providers: [ StyleRenderer ]
     * })
     */
    StyleRenderer.prototype.add = function (id, style, priority, oldClass) {
        var args = arguments;
        /** Class name or keyframe name */
        var className;
        var len = args.length;
        // clean
        if (len === 4 && args[3] == null) {
            len -= 1;
        }
        if (len === 3 && args[2] == null) {
            len -= 1;
        }
        if (len === 1) {
            className = this._theme._createStyleContent2(id, null, null, TypeStyle.LylStyle);
        }
        else if (len === 2) {
            if (typeof id === 'string') {
                className = this._theme._createStyleContent2(style, id, null, TypeStyle.LylStyle);
            }
            else if (typeof style === 'number') {
                className = this._theme._createStyleContent2(id, null, style, TypeStyle.LylStyle);
            }
            else {
                className = this._theme._createStyleContent2(id, null, null, TypeStyle.LylStyle);
                oldClass = style;
            }
        }
        else if (len === 3) {
            if (typeof id === 'string') {
                if (typeof priority === 'number') {
                    // (id, style, priority)
                    className = this._theme._createStyleContent2(style, id, priority, TypeStyle.LylStyle);
                }
                else {
                    // (id, style, oldClass)
                    className = this._theme._createStyleContent2(style, id, null, TypeStyle.LylStyle);
                    oldClass = priority;
                }
            }
            else {
                // (style, priority, oldClass)
                className = this._theme._createStyleContent2(id, null, style, TypeStyle.LylStyle);
                oldClass = priority;
            }
        }
        else if (len === 4) {
            className = this._theme._createStyleContent2(style, id, priority, TypeStyle.LylStyle);
        }
        if (this._nEl) {
            return this.updateClass(className, oldClass);
        }
        throw new Error("StyleRenderer is required on the Component!\n"
            + "Add provider for StyleRenderer in Component or Directive:\n\n"
            + "e.g:\n\n"
            + "@Component({\n"
            + "  providers: [ StyleRenderer ]\n"
            + "})\n");
    };
    /**
     * Only render style and return class name.
     */
    StyleRenderer.prototype.render = function (styleOrId, priorityOrStyle, priority) {
        if (typeof styleOrId === 'string') {
            return this._theme._createStyleContent2(priorityOrStyle, styleOrId, priority, TypeStyle.LylStyle);
        }
        return this._theme._createStyleContent2(styleOrId, null, priority, TypeStyle.LylStyle);
    };
    StyleRenderer.prototype.addClass = function (className) {
        if (!this._set.has(className)) {
            this._set.add(className);
            this._renderer.addClass(this._nEl, className);
        }
    };
    StyleRenderer.prototype.removeClass = function (className) {
        if (className && this._set.has(className)) {
            this._set.delete(className);
            this._renderer.removeClass(this._nEl, className);
        }
    };
    StyleRenderer.prototype.toggleClass = function (className, enabled) {
        if (enabled) {
            this.addClass(className);
        }
        else {
            this.removeClass(className);
        }
    };
    StyleRenderer.prototype.updateClass = function (newClassName, oldClassName) {
        this.removeClass(oldClassName);
        this.addClass(newClassName);
        return newClassName;
    };
    StyleRenderer.ctorParameters = function () { return [
        { type: LyTheme2 },
        { type: ElementRef, decorators: [{ type: Optional }] },
        { type: Renderer2, decorators: [{ type: Optional }] }
    ]; };
    StyleRenderer = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(1, Optional()),
        tslib_1.__param(2, Optional())
    ], StyleRenderer);
    return StyleRenderer;
}());
export { StyleRenderer };
/**
 * Parameter decorator to be used for create Dynamic style together with `@Input`
 * @param style style
 * @param priority priority of style, default: 0
 * @decorator
 */
export function Style(style, priority) {
    return function (target, propertyKey, descriptor) {
        var index = "" + __CLASS_NAME__ + propertyKey;
        if (descriptor) {
            var set_1 = descriptor.set;
            descriptor.set = function (val) {
                var that = this;
                if (val == null) {
                    that.sRenderer.removeClass(that[index]);
                }
                else {
                    that[index] = that.sRenderer.add(getComponentName(that) + "--" + propertyKey + "-" + val, style(val, that), priority || that.$priority || that.constructor.$priority || 0, that[index]);
                }
                set_1.call(that, val);
            };
        }
        else {
            Object.defineProperty(target, propertyKey, {
                configurable: true,
                enumerable: true,
                set: function (val) {
                    var that = this;
                    if (val == null) {
                        that.sRenderer.removeClass(that[index]);
                    }
                    else {
                        that["_" + propertyKey] = val;
                        that[index] = that.sRenderer.add(getComponentName(that) + "--" + propertyKey + "-" + val, style(val, that), priority || that.$priority || that.constructor.$priority || 0, that[index]);
                    }
                },
                get: function () {
                    return this["_" + propertyKey];
                }
            });
        }
    };
}
function getComponentName(comp) {
    return comp.constructor.Ð¸ || comp.constructor.name || 'unnamed';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXItc3R5bGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWx5bGUvdWkvIiwic291cmNlcyI6WyJzcmMvbWluaW1hbC9yZW5kZXJlci1zdHlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RSxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTdELE9BQU8sRUFBRSxTQUFTLEVBQXVCLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEUsSUFBTSxjQUFjLEdBQUcsZ0JBQWdCLENBQUM7QUFHeEM7SUFJRSx1QkFDVSxNQUFnQixFQUNaLEdBQWUsRUFDUCxTQUFvQjtRQUZoQyxXQUFNLEdBQU4sTUFBTSxDQUFVO1FBRUosY0FBUyxHQUFULFNBQVMsQ0FBVztRQU56QixTQUFJLEdBQWdCLElBQUksR0FBRyxFQUFVLENBQUM7UUFRckQsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUM7WUFDOUIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7OztPQWNHO0lBQ0gsbUNBQVcsR0FBWCxVQUFlLE1BQW9CLEVBQUUsY0FBd0I7UUFDM0QsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekYsSUFBSSxjQUFjLElBQUksT0FBTyxDQUFDLElBQUksRUFBRTtZQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM3QjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUF5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T0FBTyxJQUFJLENBQUMsTUFBSSxXQUFhLENBQUMsQ0FBQztnQkFDakMsQ0FBQzthQUNGLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQVFELFNBQVMsZ0JBQWdCLENBQUMsSUFBUztJQUNqQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQztBQUNsRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgRWxlbWVudFJlZiwgUmVuZGVyZXIyLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTHlUaGVtZTIsIFRoZW1lUmVmIH0gZnJvbSAnLi4vdGhlbWUvdGhlbWUyLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3R5bGVUZW1wbGF0ZSB9IGZyb20gJy4uL3BhcnNlJztcbmltcG9ydCB7IFR5cGVTdHlsZSwgTHlTdHlsZXMsIEx5Q2xhc3NlcyB9IGZyb20gJy4uL3RoZW1lL3N0eWxlJztcblxuY29uc3QgX19DTEFTU19OQU1FX18gPSAnX19DTEFTU19OQU1FX18nO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3R5bGVSZW5kZXJlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3NldDogU2V0PHN0cmluZz4gPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSBfbkVsOiBIVE1MRWxlbWVudDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIF90aGVtZTogTHlUaGVtZTIsXG4gICAgQE9wdGlvbmFsKCkgX2VsOiBFbGVtZW50UmVmLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgX3JlbmRlcmVyOiBSZW5kZXJlcjJcbiAgKSB7XG4gICAgaWYgKF9lbCkge1xuICAgICAgdGhpcy5fbkVsID0gX2VsLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICB0aGlzLl9zZXQgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgbXVsdGlwbGUgc3R5bGVzIGFuZCByZW5kZXIgdGhlbSBpbiB0aGUgRE9NLlxuICAgKiBAcGFyYW0gc3R5bGVzIFN0eWxlc1xuICAgKiBAcGFyYW0gYXBwbHlSb290Q2xhc3MgSWYgYGFwcGx5VG9Sb290YCBpcyBgdHJ1ZWAgYW5kIHRoZSByb290IHByb3BlcnR5IGlzIGRlZmluZWQsXG4gICAqIGl0IHdpbGwgYXV0b21hdGljYWxseSBiZSBhZGRlZCB0byB0aGUgY29tcG9uZW50LlxuICAgKlxuICAgKiBlLmcuXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGNvbnN0IFNUWUxFUyA9ICgpID0+ICh7XG4gICAqICAgcm9vdDogbHlsIGB7Li4ufWAgLy8gdGhpcyBjbGFzcyB3aWxsIGJlIGFkZGVkIHRvIHRoZSByb290IGNvbXBvbmVudFxuICAgKiB9KVxuICAgKiBgYGBcbiAgICpcbiAgICovXG4gIHJlbmRlclNoZWV0PFQ+KHN0eWxlczogVCAmIEx5U3R5bGVzLCBhcHBseVJvb3RDbGFzcz86IGJvb2xlYW4pOiBMeUNsYXNzZXM8VD4ge1xuICAgIGNvbnN0IGNsYXNzZXMgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihzdHlsZXMsIG51bGwsIG51bGwsIFR5cGVTdHlsZS5NdWx0aXBsZSk7XG4gICAgaWYgKGFwcGx5Um9vdENsYXNzICYmIGNsYXNzZXMucm9vdCkge1xuICAgICAgdGhpcy5hZGRDbGFzcyhjbGFzc2VzLnJvb3QpO1xuICAgIH1cbiAgICByZXR1cm4gY2xhc3NlcztcbiAgfVxuXG4gIGFkZChcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGVcbiAgKTogc3RyaW5nO1xuICBhZGQoXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIHByaW9yaXR5OiBudW1iZXJcbiAgKTogc3RyaW5nO1xuICBhZGQoXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIG9sZENsYXNzOiBzdHJpbmdcbiAgKTogc3RyaW5nO1xuICBhZGQoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGVcbiAgKTogc3RyaW5nO1xuXG4gIGFkZChcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgcHJpb3JpdHk6IG51bWJlcixcbiAgICBvbGRDbGFzczogc3RyaW5nIHwgbnVsbFxuICApOiBzdHJpbmc7XG4gIGFkZChcbiAgICBpZDogc3RyaW5nLFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBwcmlvcml0eTogbnVtYmVyXG4gICk6IHN0cmluZztcbiAgYWRkKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIG9sZENsYXNzOiBzdHJpbmcgfCBudWxsXG4gICk6IHN0cmluZztcblxuICBhZGQoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgcHJpb3JpdHk6IG51bWJlcixcbiAgICBvbGRDbGFzczogc3RyaW5nIHwgbnVsbFxuICApOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFJlbmRlciBzdHlsZSBhbmQgYXBwbHkgY2xhc3MgbmFtZSB0byBob3N0IENvbXBvbmVudCBvciBEaXJlY3RpdmUsXG4gICAqIHJlcXVpcmUgcHJvdmlkZSBgU3R5bGVSZW5kZXJlcmAgaW4geW91ciBDb21wb25lbnQuXG4gICAqIGUuZy5cbiAgICogQENvbXBvbmVudCh7XG4gICAqICAgLi4uXG4gICAqICAgcHJvdmlkZXJzOiBbIFN0eWxlUmVuZGVyZXIgXVxuICAgKiB9KVxuICAgKi9cbiAgYWRkKFxuICAgIGlkOiBzdHJpbmcgfCAoKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUpLFxuICAgIHN0eWxlPzogKCh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlKSB8IG51bWJlciB8IHN0cmluZyxcbiAgICBwcmlvcml0eT86IG51bWJlciB8IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwsXG4gICAgb2xkQ2xhc3M/OiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsXG4gICk6IHN0cmluZyB7XG4gICAgY29uc3QgYXJncyA9IGFyZ3VtZW50cztcbiAgICAvKiogQ2xhc3MgbmFtZSBvciBrZXlmcmFtZSBuYW1lICovXG4gICAgbGV0IGNsYXNzTmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGxldCBsZW4gPSBhcmdzLmxlbmd0aDtcblxuICAgIC8vIGNsZWFuXG4gICAgaWYgKGxlbiA9PT0gNCAmJiBhcmdzWzNdID09IG51bGwpIHtcbiAgICAgIGxlbiAtPSAxO1xuICAgIH1cbiAgICBpZiAobGVuID09PSAzICYmIGFyZ3NbMl0gPT0gbnVsbCkge1xuICAgICAgbGVuIC09IDE7XG4gICAgfVxuXG4gICAgaWYgKGxlbiA9PT0gMSkge1xuICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoaWQsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIFR5cGVTdHlsZS5MeWxTdHlsZSk7XG4gICAgfSBlbHNlIGlmIChsZW4gPT09IDIpIHtcbiAgICAgIGlmICh0eXBlb2YgaWQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHN0eWxlIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICAgIGlkLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0eWxlID09PSAnbnVtYmVyJykge1xuICAgICAgICBjbGFzc05hbWUgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihpZCBhcyAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICAgICAgICBudWxsLFxuICAgICAgICAgIHN0eWxlLFxuICAgICAgICAgIFR5cGVTdHlsZS5MeWxTdHlsZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjbGFzc05hbWUgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihpZCBhcyAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICAgICAgICBudWxsLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICAgICAgICBvbGRDbGFzcyA9IHN0eWxlIGFzIHN0cmluZztcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGxlbiA9PT0gMykge1xuICAgICAgaWYgKHR5cGVvZiBpZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBwcmlvcml0eSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAvLyAoaWQsIHN0eWxlLCBwcmlvcml0eSlcbiAgICAgICAgICBjbGFzc05hbWUgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihzdHlsZSBhcyAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBwcmlvcml0eSxcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIChpZCwgc3R5bGUsIG9sZENsYXNzKVxuICAgICAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHN0eWxlIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICAgIGlkLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICAgICAgICBvbGRDbGFzcyA9IHByaW9yaXR5O1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyAoc3R5bGUsIHByaW9yaXR5LCBvbGRDbGFzcylcbiAgICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoaWQgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBzdHlsZSBhcyBudW1iZXIsXG4gICAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICAgICAgb2xkQ2xhc3MgPSBwcmlvcml0eSBhcyBzdHJpbmc7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChsZW4gPT09IDQpIHtcbiAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHN0eWxlIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICBpZCBhcyBzdHJpbmcsXG4gICAgICAgIHByaW9yaXR5IGFzIG51bWJlcixcbiAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX25FbCkge1xuICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ2xhc3MoY2xhc3NOYW1lISwgb2xkQ2xhc3MpO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgU3R5bGVSZW5kZXJlciBpcyByZXF1aXJlZCBvbiB0aGUgQ29tcG9uZW50IVxcbmBcbiAgICAgICsgYEFkZCBwcm92aWRlciBmb3IgU3R5bGVSZW5kZXJlciBpbiBDb21wb25lbnQgb3IgRGlyZWN0aXZlOlxcblxcbmBcbiAgICAgICsgYGUuZzpcXG5cXG5gXG4gICAgICArIGBAQ29tcG9uZW50KHtcXG5gXG4gICAgICArIGAgIHByb3ZpZGVyczogWyBTdHlsZVJlbmRlcmVyIF1cXG5gXG4gICAgICArIGB9KVxcbmBcbiAgICApO1xuICB9XG5cbiAgcmVuZGVyKFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZVxuICApOiBzdHJpbmc7XG4gIHJlbmRlcihcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgcHJpb3JpdHk6IG51bWJlclxuICApOiBzdHJpbmc7XG4gIHJlbmRlcihcbiAgICBpZDogc3RyaW5nLFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZVxuICApOiBzdHJpbmc7XG4gIHJlbmRlcihcbiAgICBpZDogc3RyaW5nLFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBwcmlvcml0eTogbnVtYmVyXG4gICk6IHN0cmluZztcblxuICAvKipcbiAgICogT25seSByZW5kZXIgc3R5bGUgYW5kIHJldHVybiBjbGFzcyBuYW1lLlxuICAgKi9cbiAgcmVuZGVyKFxuICAgIHN0eWxlT3JJZDogc3RyaW5nIHwgKCh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlKSxcbiAgICBwcmlvcml0eU9yU3R5bGU/OiAoKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUpIHwgbnVtYmVyIHwgc3RyaW5nLFxuICAgIHByaW9yaXR5PzogbnVtYmVyIHwgdW5kZWZpbmVkIHwgbnVsbFxuICApOiBzdHJpbmcge1xuICAgIGlmICh0eXBlb2Ygc3R5bGVPcklkID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHByaW9yaXR5T3JTdHlsZSBhcyAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICAgICAgc3R5bGVPcklkLFxuICAgICAgICBwcmlvcml0eSxcbiAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHN0eWxlT3JJZCxcbiAgICAgIG51bGwsXG4gICAgICBwcmlvcml0eSxcbiAgICAgIFR5cGVTdHlsZS5MeWxTdHlsZSk7XG4gIH1cblxuICBhZGRDbGFzcyhjbGFzc05hbWU6IHN0cmluZykge1xuICAgIGlmICghdGhpcy5fc2V0LmhhcyhjbGFzc05hbWUpKSB7XG4gICAgICB0aGlzLl9zZXQuYWRkKGNsYXNzTmFtZSk7XG4gICAgICB0aGlzLl9yZW5kZXJlci5hZGRDbGFzcyh0aGlzLl9uRWwsIGNsYXNzTmFtZSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlQ2xhc3MoY2xhc3NOYW1lPzogc3RyaW5nIHwgbnVsbCkge1xuICAgIGlmIChjbGFzc05hbWUgJiYgdGhpcy5fc2V0LmhhcyhjbGFzc05hbWUpKSB7XG4gICAgICB0aGlzLl9zZXQuZGVsZXRlKGNsYXNzTmFtZSk7XG4gICAgICB0aGlzLl9yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLl9uRWwsIGNsYXNzTmFtZSk7XG4gICAgfVxuICB9XG5cbiAgdG9nZ2xlQ2xhc3MoY2xhc3NOYW1lOiBzdHJpbmcsIGVuYWJsZWQ6IGJvb2xlYW4pIHtcbiAgICBpZiAoZW5hYmxlZCkge1xuICAgICAgdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlQ2xhc3MobmV3Q2xhc3NOYW1lOiBzdHJpbmcsIG9sZENsYXNzTmFtZTogc3RyaW5nIHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICAgIHRoaXMucmVtb3ZlQ2xhc3Mob2xkQ2xhc3NOYW1lKTtcbiAgICB0aGlzLmFkZENsYXNzKG5ld0NsYXNzTmFtZSk7XG4gICAgcmV0dXJuIG5ld0NsYXNzTmFtZTtcbiAgfVxuXG59XG5cbi8qKlxuICogUGFyYW1ldGVyIGRlY29yYXRvciB0byBiZSB1c2VkIGZvciBjcmVhdGUgRHluYW1pYyBzdHlsZSB0b2dldGhlciB3aXRoIGBASW5wdXRgXG4gKiBAcGFyYW0gc3R5bGUgc3R5bGVcbiAqIEBwYXJhbSBwcmlvcml0eSBwcmlvcml0eSBvZiBzdHlsZSwgZGVmYXVsdDogMFxuICogQGRlY29yYXRvclxuICovXG5leHBvcnQgZnVuY3Rpb24gU3R5bGU8SU5QVVQgPSBhbnksIEMgPSBhbnk+KFxuICBzdHlsZTogKHZhbDogTm9uTnVsbGFibGU8SU5QVVQ+LCBjb21wOiBDKSA9PiAoKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUpLFxuICBwcmlvcml0eT86IG51bWJlclxuKSB7XG5cbiAgcmV0dXJuIGZ1bmN0aW9uKHRhcmdldDogV2l0aFN0eWxlcywgcHJvcGVydHlLZXk6IHN0cmluZywgZGVzY3JpcHRvcj86IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPElOUFVUPikge1xuICAgIGNvbnN0IGluZGV4ID0gYCR7X19DTEFTU19OQU1FX199JHtwcm9wZXJ0eUtleX1gO1xuICAgIGlmIChkZXNjcmlwdG9yKSB7XG4gICAgICBjb25zdCBzZXQgPSBkZXNjcmlwdG9yLnNldCE7XG4gICAgICBkZXNjcmlwdG9yLnNldCA9IGZ1bmN0aW9uICh2YWw6IElOUFVUKSB7XG4gICAgICAgIGNvbnN0IHRoYXQ6IFdpdGhTdHlsZXMgPSB0aGlzO1xuICAgICAgICBpZiAodmFsID09IG51bGwpIHtcbiAgICAgICAgICB0aGF0LnNSZW5kZXJlci5yZW1vdmVDbGFzcyh0aGF0W2luZGV4XSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhhdFtpbmRleF0gPSB0aGF0LnNSZW5kZXJlci5hZGQoXG4gICAgICAgICAgICBgJHtnZXRDb21wb25lbnROYW1lKHRoYXQpfS0tJHtwcm9wZXJ0eUtleX0tJHt2YWx9YCxcbiAgICAgICAgICAgIHN0eWxlKHZhbCBhcyBhbnksIHRoYXQgYXMgYW55KSxcbiAgICAgICAgICAgIHByaW9yaXR5IHx8IHRoYXQuJHByaW9yaXR5IHx8ICh0aGF0LmNvbnN0cnVjdG9yIGFzIGFueSkuJHByaW9yaXR5IHx8IDAsXG4gICAgICAgICAgICB0aGF0W2luZGV4XVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgc2V0LmNhbGwodGhhdCwgdmFsKTtcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHByb3BlcnR5S2V5LCB7XG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgc2V0KHZhbDogSU5QVVQpIHtcbiAgICAgICAgICBjb25zdCB0aGF0OiBXaXRoU3R5bGVzID0gdGhpcztcbiAgICAgICAgICBpZiAodmFsID09IG51bGwpIHtcbiAgICAgICAgICAgIHRoYXQuc1JlbmRlcmVyLnJlbW92ZUNsYXNzKHRoYXRbaW5kZXhdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhhdFtgXyR7cHJvcGVydHlLZXl9YF0gPSB2YWw7XG4gICAgICAgICAgICB0aGF0W2luZGV4XSA9IHRoYXQuc1JlbmRlcmVyLmFkZChcbiAgICAgICAgICAgICAgYCR7Z2V0Q29tcG9uZW50TmFtZSh0aGF0KX0tLSR7cHJvcGVydHlLZXl9LSR7dmFsfWAsXG4gICAgICAgICAgICAgIHN0eWxlKHZhbCBhcyBOb25OdWxsYWJsZTxJTlBVVD4sIHRoYXQgYXMgYW55KSxcbiAgICAgICAgICAgICAgcHJpb3JpdHkgfHwgdGhhdC4kcHJpb3JpdHkgfHwgKHRoYXQuY29uc3RydWN0b3IgYXMgYW55KS4kcHJpb3JpdHkgfHwgMCxcbiAgICAgICAgICAgICAgdGhhdFtpbmRleF1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBnZXQoKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXNbYF8ke3Byb3BlcnR5S2V5fWBdO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2l0aFN0eWxlcyB7XG4gIC8qKiBTdHlsZSBQcmlvcml0eSwgZGVmYXVsdDogMCAqL1xuICByZWFkb25seSAkcHJpb3JpdHk/OiBudW1iZXI7XG4gIHJlYWRvbmx5IHNSZW5kZXJlcjogU3R5bGVSZW5kZXJlcjtcbn1cblxuZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShjb21wOiBhbnkpIHtcbiAgcmV0dXJuIGNvbXAuY29uc3RydWN0b3Iu0LggfHwgY29tcC5jb25zdHJ1Y3Rvci5uYW1lIHx8ICd1bm5hbWVkJztcbn1cbiJdfQ==