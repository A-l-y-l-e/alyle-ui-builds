!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@alyle/ui"),require("rxjs"),require("rxjs/operators"),require("@angular/platform-browser"),require("@angular/common")):"function"==typeof define&&define.amd?define("@alyle/ui/image-cropper",["exports","@angular/core","@alyle/ui","rxjs","rxjs/operators","@angular/platform-browser","@angular/common"],e):e(((t=t||self).ly=t.ly||{},t.ly["image-Cropper"]={}),t.ng.core,t.ly.core,t.rxjs,t.rxjs.operators,t.ng.platformBrowser,t.ng.common)}(this,(function(t,e,i,r,n,o,a){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var s=function(){return(s=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function h(t,e,i,r){var n,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a}var c,l,p=function(t,e){var r=e.selectorsOf(p);return{$name:u.и,$priority:-2,root:function(){return function(e){return e+"{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:flex;overflow:hidden;position:relative;justify-content:center;align-items:center;}"+i.st2c(t.cropper&&t.cropper.root&&(t.cropper.root instanceof i.StyleCollection?t.cropper.root.setTransformer((function(t){return t(r)})):t.cropper.root(r)),""+e)}},imgContainer:function(t){return t+"{cursor:move;position:absolute;top:0;left:0;}"+t+" > canvas{pointer-events:none;}"},area:function(t){return t+"{pointer-events:none;box-shadow:0 0 0 20000px rgba(0, 0, 0, 0.4);margin:auto;}"+i.st2c(i.LY_COMMON_STYLES.fill,""+t)+i.st2c(i.LY_COMMON_STYLES.fill,t+":before,"+t+":after")+t+":before,"+t+":after{content:'';}"+t+":before{width:0;height:0;margin:auto;border-radius:50%;background:#fff;border:solid 2px rgb(255, 255, 255);}"+t+":after{border:solid 2px rgb(255, 255, 255);}"},defaultContent:function(t){return t+"{display:flex;align-items:center;justify-content:center;}"+i.st2c(i.LY_COMMON_STYLES.fill,t+","+t+" > input")+t+" *:not(input){pointer-events:none;}"+t+" > input{background:transparent;opacity:0;width:100%;height:100%;}"}}};(c=t.ImgResolution||(t.ImgResolution={}))[c.Default=0]="Default",c[c.OriginalImage=1]="OriginalImage",(l=t.ImgCropperError||(t.ImgCropperError={}))[l.Size=0]="Size",l[l.Type=1]="Type",l[l.Other=2]="Other";var g={width:250,height:200,output:t.ImgResolution.Default,antiAliased:!0},u=function(){function o(t,i,r,n,o){this._renderer=t,this.theme=i,this.elementRef=r,this.cd=n,this._ngZone=o,this.classes=this.theme.addStyleSheet(p),this._imgRect={},this._listeners=new Set,this.scaleChange=new e.EventEmitter,this.loaded=new e.EventEmitter,this.cropped=new e.EventEmitter,this.error=new e.EventEmitter,this._renderer.addClass(r.nativeElement,this.classes.root)}return Object.defineProperty(o.prototype,"config",{get:function(){return this._config},set:function(t){this._config=i.mergeDeep({},g,t);var e=this._config.maxFileSize;e&&(this.maxFileSize=e)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"scale",{get:function(){return this._scale},set:function(t){this.setScale(t)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"minScale",{get:function(){return this._minScale},enumerable:!0,configurable:!0}),o.prototype.ngOnDestroy=function(){this._listeners.forEach((function(t){return t.unsubscribe()})),this._listeners.clear()},o.prototype._imgLoaded=function(t){if(t){this._img=t;var e=this._imgCanvas.nativeElement;e.width=t.width,e.height=t.height;var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height),i.drawImage(t,0,0),this._updateMinScale(e)}},o.prototype._setStylesForContImg=function(t){var e={};if(void 0!==t.x&&void 0!==t.y){var i=this._rootRect(),r=i.width/2-t.x,n=i.height/2-t.y;this._imgRect.x=t.x,this._imgRect.y=t.y,this._imgRect.xc=r,this._imgRect.yc=n}for(var o in e.transform="translate3d("+this._imgRect.x+"px,"+this._imgRect.y+"px, 0)",e.transform+="scale("+this._scal3Fix+")",e.transformOrigin=this._imgRect.xc+"px "+this._imgRect.yc+"px 0",e["-webkit-transform"]=e.transform,e["-webkit-transform-origin"]=e.transformOrigin,e)e.hasOwnProperty(o)&&this._renderer.setStyle(this._imgContainer.nativeElement,o,e[o])},o.prototype._resize$=function(){this.isLoaded&&this.updatePosition()},o.prototype.selectInputEvent=function(e){var i=this;this._currentInputElement=e.target;var n=e.target;if(!n.files||1===n.files.length){var o=n.files[0].size,a=n.value.replace(/.*(\/|\\)/,"");if(this.maxFileSize&&o>this.maxFileSize){var s={name:a,type:n.files[0].type,size:o,error:t.ImgCropperError.Size};return this.clean(),void this.error.emit(s)}var h=new r.Observable((function(t){var e=new FileReader;return e.onerror=function(e){return t.error(e)},e.onabort=function(e){return t.error(e)},e.onload=function(e){return setTimeout((function(){t.next(e),t.complete()}),1)},e.readAsDataURL(n.files[0])})).subscribe({next:function(t){var e=t.target.result;i.config.type||(i._defaultType=n.files[0].type),i._fileName=a,i._sizeInBytes=n.files[0].size,i.setImageUrl(e),i.cd.markForCheck(),i._listeners.delete(h)},error:function(){var e={name:a,size:o,error:t.ImgCropperError.Other,errorMsg:"The File could not be loaded."};i.clean(),i.error.emit(e),i._listeners.delete(h),i.ngOnDestroy()}});this._listeners.add(h)}},o.prototype.setScale=function(t,e){var i=t>=this.minScale&&t<=1?t:this.minScale,r=null!=t&&t!==this.scale&&i!==this.scale;if(this._scale=t,r){if(this._scal3Fix=i,this.isLoaded){if(!r)return;var n=s({},this._imgRect);this.offset={x:n.x,y:n.y,left:n.xc,top:n.yc},this._setStylesForContImg({}),this._move({srcEvent:{},deltaX:0,deltaY:0})}else{if(!this.minScale)return;this._setStylesForContImg(s({},this._getCenterPoints()))}this.scaleChange.emit(t),e||this._cropIfAutoCrop()}},o.prototype._getCenterPoints=function(){var t=this.elementRef.nativeElement,e=this._imgCanvas.nativeElement;return{x:(t.offsetWidth-e.width)/2,y:(t.offsetHeight-e.height)/2}},o.prototype.fitToScreen=function(){var t=this.elementRef.nativeElement,e=t.offsetWidth,i=t.offsetHeight,r=this._img,n={width:e/r.width,height:i/r.height},o=Math.max(n.width,n.height);this.setScale(o)},o.prototype.fit=function(){this.setScale(this.minScale)},o.prototype._moveStart=function(){this.offset={x:this._imgRect.x,y:this._imgRect.y,left:this._imgRect.xc,top:this._imgRect.yc}},o.prototype._move=function(t){var e,i,r=this._imgCanvas.nativeElement,n=this._scal3Fix,o=this.config,a=this.offset;if(n&&a){var s=r.height*n<o.height&&o.extraZoomOut,h=r.width*n<o.width&&o.extraZoomOut,c=o.width/2/n>=a.left-t.deltaX/n,l=o.width/2/n+r.width-(a.left-t.deltaX/n)<=o.width/n,p=o.height/2/n>=a.top-t.deltaY/n,g=o.height/2/n+r.height-(a.top-t.deltaY/n)<=o.height/n;(c&&!h||!c&&h)&&(e=a.x+a.left-o.width/2/n),(l&&!h||!l&&h)&&(e=a.x+a.left+o.width/2/n-r.width),(p&&!s||!p&&s)&&(i=a.y+a.top-o.height/2/n),(g&&!s||!g&&s)&&(i=a.y+a.top+o.height/2/n-r.height),void 0===e&&(e=t.deltaX/n+a.x),void 0===i&&(i=t.deltaY/n+a.y),this._setStylesForContImg({x:e,y:i})}},o.prototype.updatePosition=function(t,e){var i=this._rootRect(),r=this._areaCropperRect();void 0===t&&void 0===e&&(t=this._imgRect.xc,e=this._imgRect.yc),t=r.left-i.left-(t-this.config.width/2),e=r.top-i.top-(e-this.config.height/2),this._setStylesForContImg({x:t,y:e})},o.prototype._slideEnd=function(){this._cropIfAutoCrop()},o.prototype._cropIfAutoCrop=function(){this.config.autoCrop&&this.crop()},o.prototype.zoomIn=function(){var t=this._scal3Fix+.05;t>0&&t<=1?this.setScale(t):this.setScale(1)},o.prototype.clean=function(){if(this._currentInputElement&&(this._currentInputElement.value="",this._currentInputElement=null),this.isLoaded){this._imgRect={},this.offset=void 0,this.scale=void 0,this._scal3Fix=void 0,this._rotation=0,this._minScale=void 0,this._isLoadedImg=!1,this.isLoaded=!1,this.isCropped=!1,this._originalImgBase64=void 0;var t=this._imgCanvas.nativeElement;t.width=0,t.height=0,this.cd.markForCheck()}},o.prototype.zoomOut=function(){var t=this._scal3Fix-.05;t>this.minScale&&t<=1?this.setScale(t):this.fit()},o.prototype.center=function(){var t=s({},this._getCenterPoints());this._setStylesForContImg(t),this._cropIfAutoCrop()},o.prototype.setImageUrl=function(e,i){var o=this;this.clean(),this._originalImgBase64=e;var a=function(t){var e=new Image;return e.crossOrigin="anonymous",e.src=t,e}(e=function(t){if(window.atob&&(c=t,c.startsWith(m))){var e=t.length/5,i=window.atob(t.replace(m,"")),r=document.createElement("span");r.innerHTML=i;var n=r.querySelector("svg");r.setAttribute("style","display:none"),document.body.appendChild(r);var o=parseFloat(getComputedStyle(n).width)||1,a=parseFloat(getComputedStyle(n).height)||1,s=Math.max(o,a);n.setAttribute("width",e/(o/s)+"px"),n.setAttribute("height",e/(a/s)+"px");var h=m+window.btoa(r.innerHTML);return document.body.removeChild(r),h}var c;return t}(e)),s=this._sizeInBytes,h={name:this._fileName,type:this._defaultType,originalDataURL:e};s&&(h.size=s);var c=new r.Observable((function(t){a.onerror=function(e){return t.error(e)},a.onabort=function(e){return t.error(e)},a.onload=function(){t.next(null),t.complete()}})).subscribe({next:function(){o._imgLoaded(a),h.width=a.width,h.height=a.height,o._isLoadedImg=!0,o.cd.markForCheck(),o._ngZone.onStable.pipe(n.take(1)).subscribe((function(){return setTimeout((function(){return o._ngZone.run((function(){o._updateMinScale(o._imgCanvas.nativeElement),o.isLoaded=!1,i?i():o.setScale(o.minScale,!0),o.loaded.emit(h),o.isLoaded=!0,o._cropIfAutoCrop(),o.cd.markForCheck()}))}),0)})),o._listeners.delete(c),o.ngOnDestroy()},error:function(){h.error=t.ImgCropperError.Type,o.error.emit(h),o._listeners.delete(c),o.ngOnDestroy()}});this._listeners.add(c),this._sizeInBytes=null,this._fileName=null,this._defaultType=void 0},o.prototype.rotate=function(t){var e,i,r,n,o,a,h,c=this._rotation=(i=d(e=t,360),r=d(i.result,90),n=Math.sign(e),r.result>=45?90*(r.parts+1)*n:90*r.parts*n),l=c*Math.PI/180,p=this._imgCanvas.nativeElement,g=(o=p,a=document.createElement("canvas"),h=a.getContext("2d"),a.width=o.width,a.height=o.height,h.drawImage(o,0,0),a),u=p.getContext("2d");u.clearRect(0,0,g.width,g.height);var m="rotate("+c+"deg) scale("+1/this._scal3Fix+")",f=this._imgRect.xc+"px "+this._imgRect.yc+"px 0";p.style.transform=m,p.style.webkitTransform=m,p.style.transformOrigin=f,p.style.webkitTransformOrigin=f;var y=p.getBoundingClientRect(),v=y.left,_=y.top,w=p.getBoundingClientRect();p.removeAttribute("style");var C=w.width,x=w.height;u.canvas.width=C,u.canvas.height=x,u.clearRect(0,0,C,x),u.translate(C/2,x/2),u.rotate(l),u.drawImage(g,-g.width/2,-g.height/2),this._updateMinScale(p),this.scale<this.minScale&&this.setScale(0,!0);var S=this._rootRect();this._setStylesForContImg({x:v-S.left,y:_-S.top});var b=s({},this._imgRect);this.offset={x:b.x,y:b.y,left:b.xc,top:b.yc},this._setStylesForContImg({}),this._move({srcEvent:{},deltaX:0,deltaY:0}),this._cropIfAutoCrop()},o.prototype._updateMinScale=function(t){var e=this.config;this._minScale=(e.extraZoomOut?Math.min:Math.max)(e.width/t.width,e.height/t.height)},o.prototype.imageSmoothingQuality=function(t,e,i){var r=Math.ceil(Math.log(Math.max(t.width,t.height)/Math.max(e.width,e.height))/Math.log(2))-1;r=r<=0?0:r;var n=Array.from(Array(r).keys()),o=t.getContext("2d"),a=Math.pow(10*i,r)/Math.pow(10,r),s=this._defaultType;if(r){var h=t.width*i,c=t.height*i;"image/png"!==s&&"image/svg+xml"!==s||(o.globalCompositeOperation="copy"),n.forEach((function(){o.drawImage(t,0,0,h,c)}))}var l=document.createElement("canvas"),p=l.getContext("2d");return l.width=e.width,l.height=e.height,p.drawImage(t,0,0,t.width*a,t.height*a,0,0,l.width,l.height),l},o.prototype.crop=function(t){var e=t?i.mergeDeep({},this.config||g,t):this.config,r=this._imgCrop(e);return this.cd.markForCheck(),r},o.prototype._imgCrop=function(t){var e=document.createElement("canvas"),i=this._imgRect,r=this._scal3Fix,n=i.xc-t.width/2/r,o=i.yc-t.height/2/r,a={width:t.width,height:t.height};e.width=a.width/r,e.height=a.height/r;var s=e.getContext("2d");t.fill&&(s.fillStyle=t.fill,s.fillRect(0,0,e.width,e.height)),s.drawImage(this._imgCanvas.nativeElement,-n,-o);var h=e,c=t.antiAliased?.5:1;0===t.output?h=this.imageSmoothingQuality(h,a,c):"object"==typeof t.output&&(h=this.imageSmoothingQuality(h,t.output,c));var l={dataURL:t.type?h.toDataURL(""+t.type):h.toDataURL(this._defaultType),type:this._defaultType||t.type,name:this._fileName,width:a.width,height:a.height,originalDataURL:this._originalImgBase64,scale:this._scal3Fix,rotation:this._rotation,position:{x:this._imgRect.xc,y:this._imgRect.yc}};return this.isCropped=!0,this.cropped.emit(l),l},o.prototype._rootRect=function(){return this.elementRef.nativeElement.getBoundingClientRect()},o.prototype._areaCropperRect=function(){return this._croppingContainer.nativeElement.getBoundingClientRect()},o.и="LyImageCropper",o.ctorParameters=function(){return[{type:e.Renderer2},{type:i.LyTheme2},{type:e.ElementRef},{type:e.ChangeDetectorRef},{type:e.NgZone}]},h([e.ViewChild("_imgContainer",{static:!0})],o.prototype,"_imgContainer",void 0),h([e.ViewChild("_area",{static:!1})],o.prototype,"_croppingContainer",void 0),h([e.ViewChild("_imgCanvas",{static:!0})],o.prototype,"_imgCanvas",void 0),h([e.Input()],o.prototype,"config",null),h([e.Input()],o.prototype,"scale",null),h([e.Input()],o.prototype,"maxFileSize",void 0),h([e.Output()],o.prototype,"scaleChange",void 0),h([e.Output()],o.prototype,"loaded",void 0),h([e.Output()],o.prototype,"cropped",void 0),h([e.Output()],o.prototype,"error",void 0),h([e.HostListener("window:resize")],o.prototype,"_resize$",null),o=h([e.Component({changeDetection:e.ChangeDetectionStrategy.OnPush,preserveWhitespaces:!1,selector:"ly-img-cropper, ly-image-cropper",template:'<div #_imgContainer\n[className]="classes.imgContainer"\n(slidestart)="_moveStart()"\n(slide)="_move($event)"\n(slideend)="_slideEnd()">\n  <canvas #_imgCanvas></canvas>\n</div>\n<div #_area *ngIf="_isLoadedImg; else content" [className]="classes.area" [ngStyle]="{\n  width: config.width + \'px\',\n  height: config.height + \'px\'\n}"></div>\n<ng-template #content>\n  <div [className]="classes.defaultContent">\n    <input #_fileInput type="file" (change)="selectInputEvent($event)" accept="image/*">\n    <ng-content></ng-content>\n  </div>\n</ng-template>\n'})],o)}();function d(t,e){var i,r=Math.abs(t),n=Math.floor(r/e);return i=n?r-e*n:t,r!==t&&(i*=-1),{result:i,parts:n}}var m="data:image/svg+xml;base64,";var f=function(){function t(){}return t=h([e.NgModule({imports:[a.CommonModule],exports:[u],providers:[{provide:o.HAMMER_GESTURE_CONFIG,useClass:i.LyHammerGestureConfig}],declarations:[u]})],t)}();t.LyImageCropper=u,t.LyImageCropperModule=f,t.STYLES=p,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=alyle-ui-image-cropper.umd.min.js.map