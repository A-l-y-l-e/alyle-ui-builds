!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@alyle/ui"),require("rxjs"),require("rxjs/operators"),require("@angular/platform-browser"),require("@angular/common")):"function"==typeof define&&define.amd?define("@alyle/ui/image-cropper",["exports","@angular/core","@alyle/ui","rxjs","rxjs/operators","@angular/platform-browser","@angular/common"],e):e(((t=t||self).ly=t.ly||{},t.ly["image-Cropper"]={}),t.ng.core,t.ly.core,t.rxjs,t.rxjs.operators,t.ng.platformBrowser,t.ng.common)}(this,(function(t,e,i,r,o,n,a){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var s=function(){return(s=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function h(t,e,i,r){var o,n=arguments.length,a=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(n<3?o(a):n>3?o(e,i,a):o(e,i))||a);return n>3&&a&&Object.defineProperty(e,i,a),a}var c,l,p=function(t,e){var r=e.selectorsOf(p);return{$name:u.и,$priority:-2,root:function(){return function(e){return e+"{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:flex;overflow:hidden;position:relative;justify-content:center;align-items:center;}"+i.st2c(t.cropper&&t.cropper.root&&(t.cropper.root instanceof i.StyleCollection?t.cropper.root.setTransformer((function(t){return t(r)})):t.cropper.root(r)),""+e)}},imgContainer:function(t){return t+"{cursor:move;position:absolute;top:0;left:0;}"+t+" > canvas{pointer-events:none;}"},area:function(t){return t+"{pointer-events:none;box-shadow:0 0 0 20000px rgba(0, 0, 0, 0.4);margin:auto;}"+i.st2c(i.LY_COMMON_STYLES.fill,""+t)+i.st2c(i.LY_COMMON_STYLES.fill,t+":before,"+t+":after")+t+":before,"+t+":after{content:'';}"+t+":before{width:0;height:0;margin:auto;border-radius:50%;background:#fff;border:solid 2px rgb(255, 255, 255);}"+t+":after{border:solid 2px rgb(255, 255, 255);}"},defaultContent:function(t){return t+"{display:flex;align-items:center;justify-content:center;}"+i.st2c(i.LY_COMMON_STYLES.fill,t+","+t+" > input")+t+" *:not(input){pointer-events:none;}"+t+" > input{background:transparent;opacity:0;width:100%;height:100%;}"}}};(c=t.ImgResolution||(t.ImgResolution={}))[c.Default=0]="Default",c[c.OriginalImage=1]="OriginalImage",(l=t.ImgCropperError||(t.ImgCropperError={}))[l.Size=0]="Size",l[l.Type=1]="Type",l[l.Other=2]="Other";var g={width:250,height:200,output:t.ImgResolution.Default,antiAliased:!0},u=function(){function n(t,i,r,o,n){this._renderer=t,this.theme=i,this.elementRef=r,this.cd=o,this._ngZone=n,this.classes=this.theme.addStyleSheet(p),this._imgRect={},this._listeners=new Set,this.scaleChange=new e.EventEmitter,this.loaded=new e.EventEmitter,this.cropped=new e.EventEmitter,this.error=new e.EventEmitter,this._renderer.addClass(r.nativeElement,this.classes.root)}return Object.defineProperty(n.prototype,"config",{get:function(){return this._config},set:function(t){this._config=i.mergeDeep({},g,t);var e=this._config.maxFileSize;e&&(this.maxFileSize=e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scale",{get:function(){return this._scale},set:function(t){this.setScale(t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"minScale",{get:function(){return this._minScale},enumerable:!0,configurable:!0}),n.prototype.ngOnDestroy=function(){this._listeners.forEach((function(t){return t.unsubscribe()})),this._listeners.clear()},n.prototype._imgLoaded=function(t){if(t){this._img=t;var e=this._imgCanvas.nativeElement;e.width=t.width,e.height=t.height;var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height),i.drawImage(t,0,0),this._updateMinScale(e)}},n.prototype._setStylesForContImg=function(t){var e={};if(void 0!==t.x&&void 0!==t.y){var i=this._rootRect(),r=i.width/2-t.x,o=i.height/2-t.y;this._imgRect.x=t.x,this._imgRect.y=t.y,this._imgRect.xc=r,this._imgRect.yc=o}for(var n in e.transform="translate3d("+this._imgRect.x+"px,"+this._imgRect.y+"px, 0)",e.transform+="scale("+this._scal3Fix+")",e.transformOrigin=this._imgRect.xc+"px "+this._imgRect.yc+"px 0",e["-webkit-transform"]=e.transform,e["-webkit-transform-origin"]=e.transformOrigin,e)e.hasOwnProperty(n)&&this._renderer.setStyle(this._imgContainer.nativeElement,n,e[n])},n.prototype._resize$=function(){this.isLoaded&&this.updatePosition()},n.prototype.selectInputEvent=function(e){var i=this,o=e.target;if(!o.files||1===o.files.length){var n=o.files[0].size,a=o.value.replace(/.*(\/|\\)/,"");if(this.maxFileSize&&n>this.maxFileSize){var s={name:a,type:o.files[0].type,size:n,error:t.ImgCropperError.Size};return this.clean(),void this.error.emit(s)}var h=new r.Observable((function(t){var e=new FileReader;return e.onerror=function(e){return t.error(e)},e.onabort=function(e){return t.error(e)},e.onload=function(e){return setTimeout((function(){t.next(e),t.complete()}),1)},e.readAsDataURL(o.files[0])})).subscribe({next:function(t){var e=t.target.result;i.config.type||(i._defaultType=o.files[0].type),i._fileName=a,i._sizeInBytes=o.files[0].size,i.setImageUrl(e),i.cd.markForCheck(),i._listeners.delete(h)},error:function(){var e={name:a,size:n,error:t.ImgCropperError.Other,errorMsg:"The File could not be loaded."};i.clean(),i.error.emit(e),i._listeners.delete(h),i.ngOnDestroy()}});this._listeners.add(h)}},n.prototype.setScale=function(t,e){var i=t>=this.minScale&&t<=1?t:this.minScale,r=null!=t&&t!==this.scale&&i!==this.scale;if(this._scale=t,r){if(this._scal3Fix=i,this.isLoaded){if(!r)return;var o=s({},this._imgRect);this.offset={x:o.x,y:o.y,left:o.xc,top:o.yc},this._setStylesForContImg({}),this._move({srcEvent:{},deltaX:0,deltaY:0})}else{if(!this.minScale)return;this._setStylesForContImg(s({},this._getCenterPoints()))}this.scaleChange.emit(t),e||this._cropIfAutoCrop()}},n.prototype._getCenterPoints=function(){var t=this.elementRef.nativeElement,e=this._imgCanvas.nativeElement;return{x:(t.offsetWidth-e.width)/2,y:(t.offsetHeight-e.height)/2}},n.prototype.fitToScreen=function(){var t=this.elementRef.nativeElement,e=t.offsetWidth,i=t.offsetHeight,r=this._img,o={width:e/r.width,height:i/r.height},n=Math.max(o.width,o.height);this.setScale(n)},n.prototype.fit=function(){this.setScale(this.minScale)},n.prototype._moveStart=function(){this.offset={x:this._imgRect.x,y:this._imgRect.y,left:this._imgRect.xc,top:this._imgRect.yc}},n.prototype._move=function(t){var e,i,r=this._imgCanvas.nativeElement,o=this._scal3Fix,n=this.config,a=this.offset;if(o&&a){var s=r.height*o<n.height&&n.extraZoomOut,h=r.width*o<n.width&&n.extraZoomOut,c=n.width/2/o>=a.left-t.deltaX/o,l=n.width/2/o+r.width-(a.left-t.deltaX/o)<=n.width/o,p=n.height/2/o>=a.top-t.deltaY/o,g=n.height/2/o+r.height-(a.top-t.deltaY/o)<=n.height/o;(c&&!h||!c&&h)&&(e=a.x+a.left-n.width/2/o),(l&&!h||!l&&h)&&(e=a.x+a.left+n.width/2/o-r.width),(p&&!s||!p&&s)&&(i=a.y+a.top-n.height/2/o),(g&&!s||!g&&s)&&(i=a.y+a.top+n.height/2/o-r.height),void 0===e&&(e=t.deltaX/o+a.x),void 0===i&&(i=t.deltaY/o+a.y),this._setStylesForContImg({x:e,y:i})}},n.prototype.updatePosition=function(t,e){var i=this._rootRect(),r=this._areaCropperRect();void 0===t&&void 0===e&&(t=this._imgRect.xc,e=this._imgRect.yc),t=r.left-i.left-(t-this.config.width/2),e=r.top-i.top-(e-this.config.height/2),this._setStylesForContImg({x:t,y:e})},n.prototype._slideEnd=function(){this._cropIfAutoCrop()},n.prototype._cropIfAutoCrop=function(){this.config.autoCrop&&this.crop()},n.prototype.zoomIn=function(){var t=this._scal3Fix+.05;t>0&&t<=1?this.setScale(t):this.setScale(1)},n.prototype.clean=function(){if(this.isLoaded){this._imgRect={},this.offset=void 0,this.scale=void 0,this._scal3Fix=void 0,this._rotation=0,this._minScale=void 0,this._isLoadedImg=!1,this.isLoaded=!1,this.isCropped=!1,this._originalImgBase64=void 0;var t=this._imgCanvas.nativeElement;t.width=0,t.height=0,this.cd.markForCheck()}},n.prototype.zoomOut=function(){var t=this._scal3Fix-.05;t>this.minScale&&t<=1?this.setScale(t):this.fit()},n.prototype.center=function(){var t=s({},this._getCenterPoints());this._setStylesForContImg(t),this._cropIfAutoCrop()},n.prototype.setImageUrl=function(e,i){var n=this;this.clean(),this._originalImgBase64=e;var a=function(t){var e=new Image;return e.crossOrigin="anonymous",e.src=t,e}(e=function(t){if(window.atob&&(c=t,c.startsWith(m))){var e=t.length/5,i=window.atob(t.replace(m,"")),r=document.createElement("span");r.innerHTML=i;var o=r.querySelector("svg");r.setAttribute("style","display:none"),document.body.appendChild(r);var n=parseFloat(getComputedStyle(o).width)||1,a=parseFloat(getComputedStyle(o).height)||1,s=Math.max(n,a);o.setAttribute("width",e/(n/s)+"px"),o.setAttribute("height",e/(a/s)+"px");var h=m+window.btoa(r.innerHTML);return document.body.removeChild(r),h}var c;return t}(e)),s=this._sizeInBytes,h={name:this._fileName,type:this._defaultType,originalDataURL:e};s&&(h.size=s);var c=new r.Observable((function(t){a.onerror=function(e){return t.error(e)},a.onabort=function(e){return t.error(e)},a.onload=function(){t.next(null),t.complete()}})).subscribe({next:function(){n._imgLoaded(a),h.width=a.width,h.height=a.height,n._isLoadedImg=!0,n.cd.markForCheck(),n._ngZone.onStable.pipe(o.take(1)).subscribe((function(){return setTimeout((function(){return n._ngZone.run((function(){n._updateMinScale(n._imgCanvas.nativeElement),n.isLoaded=!1,i?i():n.setScale(n.minScale,!0),n.loaded.emit(h),n.isLoaded=!0,n._cropIfAutoCrop(),n.cd.markForCheck()}))}),0)})),n._listeners.delete(c),n.ngOnDestroy()},error:function(){h.error=t.ImgCropperError.Type,n.error.emit(h),n._listeners.delete(c),n.ngOnDestroy()}});this._listeners.add(c),this._sizeInBytes=null,this._fileName=null,this._defaultType=void 0},n.prototype.rotate=function(t){var e,i,r,o,n,a,h,c=this._rotation=(i=d(e=t,360),r=d(i.result,90),o=Math.sign(e),r.result>=45?90*(r.parts+1)*o:90*r.parts*o),l=c*Math.PI/180,p=this._imgCanvas.nativeElement,g=(n=p,a=document.createElement("canvas"),h=a.getContext("2d"),a.width=n.width,a.height=n.height,h.drawImage(n,0,0),a),u=p.getContext("2d");u.clearRect(0,0,g.width,g.height);var m="rotate("+c+"deg) scale("+1/this._scal3Fix+")",f=this._imgRect.xc+"px "+this._imgRect.yc+"px 0";p.style.transform=m,p.style.webkitTransform=m,p.style.transformOrigin=f,p.style.webkitTransformOrigin=f;var y=p.getBoundingClientRect(),v=y.left,_=y.top,w=p.getBoundingClientRect();p.removeAttribute("style");var C=w.width,x=w.height;u.canvas.width=C,u.canvas.height=x,u.clearRect(0,0,C,x),u.translate(C/2,x/2),u.rotate(l),u.drawImage(g,-g.width/2,-g.height/2),this._updateMinScale(p),this.scale<this.minScale&&this.setScale(0,!0);var S=this._rootRect();this._setStylesForContImg({x:v-S.left,y:_-S.top});var b=s({},this._imgRect);this.offset={x:b.x,y:b.y,left:b.xc,top:b.yc},this._setStylesForContImg({}),this._move({srcEvent:{},deltaX:0,deltaY:0}),this._cropIfAutoCrop()},n.prototype._updateMinScale=function(t){var e=this.config;this._minScale=(e.extraZoomOut?Math.min:Math.max)(e.width/t.width,e.height/t.height)},n.prototype.imageSmoothingQuality=function(t,e,i){var r=Math.ceil(Math.log(Math.max(t.width,t.height)/Math.max(e.width,e.height))/Math.log(2))-1;r=r<=0?0:r;var o=Array.from(Array(r).keys()),n=t.getContext("2d"),a=Math.pow(10*i,r)/Math.pow(10,r),s=this._defaultType;if(r){var h=t.width*i,c=t.height*i;"image/png"!==s&&"image/svg+xml"!==s||(n.globalCompositeOperation="copy"),o.forEach((function(){n.drawImage(t,0,0,h,c)}))}var l=document.createElement("canvas"),p=l.getContext("2d");return l.width=e.width,l.height=e.height,p.drawImage(t,0,0,t.width*a,t.height*a,0,0,l.width,l.height),l},n.prototype.crop=function(t){var e=t?i.mergeDeep({},this.config||g,t):this.config,r=this._imgCrop(e);return this.cd.markForCheck(),r},n.prototype._imgCrop=function(t){var e=document.createElement("canvas"),i=this._imgRect,r=this._scal3Fix,o=i.xc-t.width/2/r,n=i.yc-t.height/2/r,a={width:t.width,height:t.height};e.width=a.width/r,e.height=a.height/r;var s=e.getContext("2d");t.fill&&(s.fillStyle=t.fill,s.fillRect(0,0,e.width,e.height)),s.drawImage(this._imgCanvas.nativeElement,-o,-n);var h=e,c=t.antiAliased?.5:1;0===t.output?h=this.imageSmoothingQuality(h,a,c):"object"==typeof t.output&&(h=this.imageSmoothingQuality(h,t.output,c));var l={dataURL:t.type?h.toDataURL(""+t.type):h.toDataURL(this._defaultType),type:this._defaultType||t.type,name:this._fileName,width:a.width,height:a.height,originalDataURL:this._originalImgBase64,scale:this._scal3Fix,rotation:this._rotation,position:{x:this._imgRect.xc,y:this._imgRect.yc}};return this.isCropped=!0,this.cropped.emit(l),l},n.prototype._rootRect=function(){return this.elementRef.nativeElement.getBoundingClientRect()},n.prototype._areaCropperRect=function(){return this._croppingContainer.nativeElement.getBoundingClientRect()},n.и="LyImageCropper",n.ctorParameters=function(){return[{type:e.Renderer2},{type:i.LyTheme2},{type:e.ElementRef},{type:e.ChangeDetectorRef},{type:e.NgZone}]},h([e.ViewChild("_imgContainer",{static:!0})],n.prototype,"_imgContainer",void 0),h([e.ViewChild("_area",{static:!1})],n.prototype,"_croppingContainer",void 0),h([e.ViewChild("_imgCanvas",{static:!0})],n.prototype,"_imgCanvas",void 0),h([e.Input()],n.prototype,"config",null),h([e.Input()],n.prototype,"scale",null),h([e.Input()],n.prototype,"maxFileSize",void 0),h([e.Output()],n.prototype,"scaleChange",void 0),h([e.Output()],n.prototype,"loaded",void 0),h([e.Output()],n.prototype,"cropped",void 0),h([e.Output()],n.prototype,"error",void 0),h([e.HostListener("window:resize")],n.prototype,"_resize$",null),n=h([e.Component({changeDetection:e.ChangeDetectionStrategy.OnPush,preserveWhitespaces:!1,selector:"ly-img-cropper, ly-image-cropper",template:'<div #_imgContainer\n[className]="classes.imgContainer"\n(slidestart)="_moveStart()"\n(slide)="_move($event)"\n(slideend)="_slideEnd()">\n  <canvas #_imgCanvas></canvas>\n</div>\n<div #_area *ngIf="_isLoadedImg; else content" [className]="classes.area" [ngStyle]="{\n  width: config.width + \'px\',\n  height: config.height + \'px\'\n}"></div>\n<ng-template #content>\n  <div [className]="classes.defaultContent">\n    <input #_fileInput type="file" (change)="selectInputEvent($event)" accept="image/*">\n    <ng-content></ng-content>\n  </div>\n</ng-template>\n'})],n)}();function d(t,e){var i,r=Math.abs(t),o=Math.floor(r/e);return i=o?r-e*o:t,r!==t&&(i*=-1),{result:i,parts:o}}var m="data:image/svg+xml;base64,";var f=function(){function t(){}return t=h([e.NgModule({imports:[a.CommonModule],exports:[u],providers:[{provide:n.HAMMER_GESTURE_CONFIG,useClass:i.LyHammerGestureConfig}],declarations:[u]})],t)}();t.LyImageCropper=u,t.LyImageCropperModule=f,t.STYLES=p,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=alyle-ui-image-cropper.umd.min.js.map