!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@alyle/ui"),require("rxjs/operators"),require("@angular/platform-browser"),require("@angular/common")):"function"==typeof define&&define.amd?define("@alyle/ui/resizing-cropping-images",["exports","@angular/core","@alyle/ui","rxjs/operators","@angular/platform-browser","@angular/common"],e):e((t.alyle=t.alyle||{},t.alyle.ui=t.alyle.ui||{},t.alyle.ui["resizing-cropping-images"]={}),t.ng.core,t.alyle.ui,t.rxjs.operators,t.ng.platformBrowser,t.ng.common)}(this,function(t,r,i,o,e,n){"use strict";var h=function(){return(h=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},a={root:{"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none",userSelect:"none",display:"flex",overflow:"hidden",position:"relative",justifyContent:"center",alignItems:"center"},imgContainer:{cursor:"move",position:"absolute",top:0,left:0,"& > canvas":{width:"100%",height:"100%",pointerEvents:"none"}},croppingContainer:{position:"absolute",pointerEvents:"none",boxShadow:"0 0 0 20000px rgba(0, 0, 0, 0.4)","&:before, &:after":h({},i.LY_COMMON_STYLES.fill,{content:"''"}),"&:before":{width:0,height:0,margin:"auto",borderRadius:"50%",background:"#fff",border:"solid 2px rgb(255, 255, 255)"},"&:after":{border:"solid 2px rgb(255, 255, 255)"}},croppContent:{display:"flex",alignItems:"center",justifyContent:"center","&, & > input":i.LY_COMMON_STYLES.fill,"& *:not(input)":{pointerEvents:"none"},"& > input":{background:"transparent",opacity:0,width:"100%",height:"100%"}}},s={Default:0,OriginalImage:1};s[s.Default]="Default",s[s.OriginalImage]="OriginalImage";var c={width:250,height:200,output:s.Default,antiAliased:!0},l=function(){function t(t,e,i,n,o){this._renderer=t,this.theme=e,this.elementRef=i,this.cd=n,this._ngZone=o,this.classes=this.theme.addStyleSheet(a,-2),this._imgRect={},this.scaleChange=new r.EventEmitter,this.loaded=new r.EventEmitter,this.cropped=new r.EventEmitter,this.error=new r.EventEmitter,this._renderer.addClass(i.nativeElement,this.classes.root)}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},set:function(t){this._config=i.mergeDeep({},c,t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this._scale},set:function(t){this.setScale(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minScale",{get:function(){return this._minScale},enumerable:!0,configurable:!0}),t.prototype._imgLoaded=function(t){if(t){this._img=t;var e=this._imgCanvas.nativeElement;e.height=t.height,e.width=t.width,e.getContext("2d").drawImage(t,0,0);var i={width:this.config.width/e.width,height:this.config.height/e.height};this._minScale=g(Math.max(i.width,i.height),4)}},t.prototype._setStylesForContImg=function(t){var e={width:t.width+"px",height:t.height+"px"};if(void 0!==t.x&&void 0!==t.y){var i=this._rootRect(),n=this._imgContainerRect(),o=i.width/2-t.x,r=i.height/2-t.y;e.transform="translate3d("+g(t.x)+"px,"+g(t.y)+"px, 0)",this._imgRect.x=g(t.x),this._imgRect.y=g(t.y),this._imgRect.xc=g(o),this._imgRect.yc=g(r),this._imgRect.wt=g(n.width),this._imgRect.ht=g(n.height)}for(var a in this._imgRect.w=g(t.width),this._imgRect.h=g(t.height),e)e.hasOwnProperty(a)&&this._renderer.setStyle(this._imgContainer.nativeElement,a,e[a])},t.prototype.resize$=function(){this.isLoaded&&this.updatePosition()},t.prototype.selectInputEvent=function(t){var i=this,e=t.target;if(1===e.files.length){var n=new FileReader;this._fileName=e.value.replace(/.*(\/|\\)/,""),this._defaultType=null,this.config.type||(this._defaultType=e.files[0].type),n.addEventListener("loadend",function(t){var e=t.target.result;i.setImageUrl(e),i.cd.markForCheck()}),n.readAsDataURL(e.files[0])}},t.prototype.setScale=function(t,e){var i=(t=t>this.minScale&&t<=1?t:this.minScale)===this.scale;if(this._scale=t,!i){t=this._scal3Fix=g(t,4);var n=this._imgCanvas.nativeElement,o=n.width*t,r=n.height*t,a=this._rootRect();if(this.isLoaded){var s=h({},this._imgRect);this.offset={x:a.width/2-s.x,y:a.height/2-s.y,left:s.x,top:s.y},this._setStylesForContImg({width:o,height:r}),this._move({srcEvent:{},center:{x:a.width/2-this.offset.x*(o/s.w)+a.x+this.offset.x,y:a.height/2-this.offset.y*(r/s.h)+a.y+this.offset.y}})}else this._setStylesForContImg(h({width:o,height:r},this._customCenter(o,r)));this.scaleChange.emit(this._scale),e||this._cropIfAutoCrop()}},t.prototype._customCenter=function(t,e){var i=this.elementRef.nativeElement;return{x:(i.offsetWidth-t)/2,y:(i.offsetHeight-e)/2}},t.prototype.fitToScreen=function(){var t=this.elementRef.nativeElement,e=t.offsetWidth,i=t.offsetHeight,n=this._img,o={width:e/n.width,height:i/n.height},r=Math.max(o.width,o.height);this.setScale(r)},t.prototype.fit=function(){this.setScale(0)},t.prototype._moveStart=function(t){var e=this._rootRect(),i=this._imgRect;this.offset={x:t.center.x-e.x-i.x,y:t.center.y-e.y-i.y,left:i.x,top:i.y}},t.prototype._move=function(t){var e,i,n=this._rootRect(),o=this._imgRect,r=this._areaCropperRect();t.center.x-this.offset.x>r.x&&(e=r.x-n.x),t.center.y-this.offset.y>r.y&&(i=r.y-n.y),t.center.x-this.offset.x+o.w<r.x+r.width&&(e=r.x-n.x-o.w+r.width),t.center.y-this.offset.y+o.h<r.y+r.height&&(i=r.y-n.y-o.h+r.height),t.srcEvent&&t.srcEvent.shiftKey&&(Math.abs(t.deltaX)===Math.max(Math.abs(t.deltaX),Math.abs(t.deltaY))?i=this.offset.top:e=this.offset.left),void 0===e&&(e=t.center.x-n.x-this.offset.x),void 0===i&&(i=t.center.y-n.y-this.offset.y),this._setStylesForContImg({width:this._imgContainer.nativeElement.offsetWidth,height:this._imgContainer.nativeElement.offsetHeight,x:e,y:i})},t.prototype.updatePosition=function(t,e){var i=this._rootRect(),n=this._areaCropperRect();void 0===t&&void 0===e&&(t=this._imgRect.xc,e=this._imgRect.yc),t=n.x-i.x-(t-this.config.width/2),e=n.y-i.y-(e-this.config.height/2),this._setStylesForContImg({width:this._imgContainer.nativeElement.offsetWidth,height:this._imgContainer.nativeElement.offsetHeight,x:t,y:e})},t.prototype._slideEnd=function(){this._cropIfAutoCrop()},t.prototype._cropIfAutoCrop=function(){this.config.autoCrop&&this.crop()},t.prototype.zoomIn=function(){var t=g(this._scal3Fix+.05,4);0<t&&t<=1?this.setScale(t):this.setScale(1)},t.prototype.clean=function(){this._defaultType=null,this._isLoadedImg=!1,this.isLoaded=!1,this.isCropped=!1,this._originalImgBase64=null;var t=this._imgCanvas.nativeElement;t.width=0,t.height=0,this.cd.markForCheck()},t.prototype.zoomOut=function(){var t=g(this._scal3Fix-.05,4);t>this.minScale&&t<=1?this.setScale(t):this.fit()},t.prototype.center=function(){var t=this._imgRect,e=h({width:t.w,height:t.h},this._customCenter(t.w,t.h));this._setStylesForContImg(e),this._cropIfAutoCrop()},t.prototype.setImageUrl=function(t){var e=this;this._originalImgBase64=t;var i=new Image,n={name:this._fileName,type:this._defaultType,dataURL:null,base64:null,width:null,height:null,scale:null,originalDataURL:t,rotation:null,position:null};i.src=t,i.addEventListener("error",function(){e.clean(),e.error.emit(n)}),i.addEventListener("load",function(){e._imgLoaded(i),n.width=i.width,n.height=i.height,e._isLoadedImg=!0,e.cd.markForCheck(),e._ngZone.onStable.pipe(o.take(1)).subscribe(function(){return e._ngZone.run(function(){e.isLoaded=!1,e.setScale(0,!0),e.loaded.emit(n),e.isLoaded=!0,e._cropIfAutoCrop(),e.cd.markForCheck()})})})},t.prototype.rotate=function(t){var e=this._rotation=function d(t){var e=m(m(t,360).result,90),i=Math.sign(t);return 45<=e.result?90*(e.parts+1)*i:90*e.parts*i}(t),i=e*Math.PI/180,n=this._imgCanvas.nativeElement,o=function f(t){var e=document.createElement("canvas"),i=e.getContext("2d");return e.width=t.width,e.height=t.height,i.drawImage(t,0,0),e}(n),r=n.getContext("2d");r.clearRect(0,0,o.width,o.height),this._renderer.setStyle(n,"transform","rotate("+e+"deg)"),this._renderer.setStyle(n,"transformOrigin",this._imgRect.xc+"px "+this._imgRect.yc+"px 0");var a=n.getBoundingClientRect(),s=a.x,h=a.y;this._renderer.setStyle(n,"width","initial"),this._renderer.setStyle(n,"height","initial");var c=n.getBoundingClientRect();this._renderer.removeStyle(n,"transform"),this._renderer.removeStyle(n,"transformOrigin"),this._renderer.removeStyle(n,"width"),this._renderer.removeStyle(n,"height");var l=c.width,g=c.height;r.canvas.width=l,r.canvas.height=g,r.clearRect(0,0,l,g),r.translate(l/2,g/2),r.rotate(i),r.drawImage(o,-o.width/2,-o.height/2);var p=this._rootRect();this._setStylesForContImg({width:l*this._scal3Fix,height:g*this._scal3Fix,x:s-p.x,y:h-p.y}),this._cropIfAutoCrop()},t.prototype.imageSmoothingQuality=function(t,e,i){var n=Math.ceil(Math.log(Math.max(t.width,t.height)/Math.max(e.height,e.width))/Math.log(2))-1;n=n<=0?0:n;var o=Array.from(Array(n).keys()),r=t.getContext("2d"),a=Math.pow(10*i,n)/Math.pow(10,n);if(n){var s=t.width*i,h=t.height*i;r.globalCompositeOperation="copy",o.forEach(function(){r.drawImage(t,0,0,s,h)})}var c=document.createElement("canvas"),l=c.getContext("2d");return c.width=e.width,c.height=e.height,l.drawImage(t,0,0,t.width*a,t.height*a,0,0,c.width,c.height),c},t.prototype.crop=function(t){var e=t?i.mergeDeep({},this.config||c,t):this.config;return this._imgCrop(e)},t.prototype._imgCrop=function(t){var e=document.createElement("canvas"),i=this._imgRect,n=i.xc-t.width/2,o=i.yc-t.height/2,r=this._scal3Fix,a={width:t.width,height:t.height};e.width=a.width/r,e.height=a.height/r;var s=e.getContext("2d");t.fill&&(s.fillStyle=t.fill,s.fillRect(0,0,e.width,e.height)),s.drawImage(this._imgCanvas.nativeElement,-n/r,-o/r);var h,c=e,l=t.antiAliased?.5:1;0===t.output?c=this.imageSmoothingQuality(c,a,l):"object"==typeof t.output&&(c=this.imageSmoothingQuality(c,t.output,l));var g={dataURL:h=t.type?c.toDataURL("image/"+t.type):c.toDataURL(this._defaultType),base64:h,type:this._defaultType||t.type,name:this._fileName,width:a.width,height:a.height,originalDataURL:this._originalImgBase64,scale:this.scale,rotation:this._rotation,position:{x:this._imgRect.xc,y:this._imgRect.yc}};return this.isCropped=!0,this.cropped.emit(g),g},t.prototype._rootRect=function(){return this.elementRef.nativeElement.getBoundingClientRect()},t.prototype._imgContainerRect=function(){return this._imgContainer.nativeElement.getBoundingClientRect()},t.prototype._areaCropperRect=function(){return this._croppingContainer.nativeElement.getBoundingClientRect()},t.decorators=[{type:r.Component,args:[{changeDetection:r.ChangeDetectionStrategy.OnPush,preserveWhitespaces:!1,selector:"ly-img-cropper, ly-cropping",template:'<div #_imgContainer\n[className]="classes.imgContainer"\n(slidestart)="_moveStart($event)"\n(slide)="_move($event)"\n(slideend)="_slideEnd()">\n  <canvas #_imgCanvas></canvas>\n</div>\n<div #_croppingContainer *ngIf="_isLoadedImg; else content" [className]="classes.croppingContainer" [ngStyle]="{\n  width: config.width + \'px\',\n  height: config.height + \'px\'\n}"></div>\n<ng-template #content>\n  <div [className]="classes.croppContent">\n    <input #_fileInput type="file" (change)="selectInputEvent($event)" accept="image/*">\n    <ng-content></ng-content>\n  </div>\n</ng-template>\n'}]}],t.ctorParameters=function(){return[{type:r.Renderer2},{type:i.LyTheme2},{type:r.ElementRef},{type:r.ChangeDetectorRef},{type:r.NgZone}]},t.propDecorators={_imgContainer:[{type:r.ViewChild,args:["_imgContainer"]}],_croppingContainer:[{type:r.ViewChild,args:["_croppingContainer"]}],_imgCanvas:[{type:r.ViewChild,args:["_imgCanvas"]}],scaleChange:[{type:r.Output}],config:[{type:r.Input}],scale:[{type:r.Input}],loaded:[{type:r.Output}],cropped:[{type:r.Output}],error:[{type:r.Output}],resize$:[{type:r.HostListener,args:["window:resize"]}]},t}();function m(t,e){var i,n=Math.abs(t),o=Math.floor(n/e);return i=o?n-e*o:t,n!==t&&(i*=-1),{result:i,parts:o}}function g(t,e){return+parseFloat(t).toFixed(e||0)}var p=function(){function t(){}return t.decorators=[{type:r.NgModule,args:[{imports:[n.CommonModule],exports:[l],providers:[{provide:e.HAMMER_GESTURE_CONFIG,useClass:i.LyHammerGestureConfig}],declarations:[l]}]}],t}();t.ImgResolution=s,t.LyResizingCroppingImages=l,t.LyResizingCroppingImageModule=p,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=alyle-ui-resizing-cropping-images.umd.min.js.map