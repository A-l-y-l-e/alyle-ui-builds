!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs/operators"),require("rxjs"),require("@angular/platform-browser"),require("@angular/core"),require("@angular/common"),require("@alyle/ui")):"function"==typeof define&&define.amd?define("@alyle/ui/resizing-cropping-images",["exports","rxjs/operators","rxjs","@angular/platform-browser","@angular/core","@angular/common","@alyle/ui"],e):e((t.ly=t.ly||{},t.ly.resizingCroppingImages={}),t.rxjs.operators,t.rxjs,t.ng.platformBrowser,t.ng.core,t.ng.common,t.ly.core)}(this,function(t,l,g,e,s,i,n){"use strict";var u=function(){return(u=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},a={$priority:-2,root:{"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none",userSelect:"none",display:"flex",overflow:"hidden",position:"relative",justifyContent:"center",alignItems:"center"},imgContainer:{cursor:"move",position:"absolute",top:0,left:0,"& > canvas":{pointerEvents:"none"}},area:u({pointerEvents:"none",boxShadow:"0 0 0 20000px rgba(0, 0, 0, 0.4)"},n.LY_COMMON_STYLES.fill,{margin:"auto","&:before, &:after":u({},n.LY_COMMON_STYLES.fill,{content:"''"}),"&:before":{width:0,height:0,margin:"auto",borderRadius:"50%",background:"#fff",border:"solid 2px rgb(255, 255, 255)"},"&:after":{border:"solid 2px rgb(255, 255, 255)"}}),defaultContent:{display:"flex",alignItems:"center",justifyContent:"center","&, & > input":n.LY_COMMON_STYLES.fill,"& *:not(input)":{pointerEvents:"none"},"& > input":{background:"transparent",opacity:0,width:"100%",height:"100%"}}},r={Default:0,OriginalImage:1};r[r.Default]="Default",r[r.OriginalImage]="OriginalImage";var p={Size:0,Type:1};p[p.Size]="Size",p[p.Type]="Type";var o={width:250,height:200,output:r.Default,antiAliased:!0},h=function(){function t(t,e,i,n,r){this._renderer=t,this.theme=e,this.elementRef=i,this.cd=n,this._ngZone=r,this.classes=this.theme.addStyleSheet(a),this._imgRect={},this._listeners=new Set,this.scaleChange=new s.EventEmitter,this.loaded=new s.EventEmitter,this.cropped=new s.EventEmitter,this.error=new s.EventEmitter,this._renderer.addClass(i.nativeElement,this.classes.root);var o=this.theme.variables.imgCropper;o&&o.root&&this._renderer.addClass(this.elementRef.nativeElement,this.theme.style(o.root,-2,a))}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},set:function(t){this._config=n.mergeDeep({},o,t);var e=this._config.maxFileSize;e&&(this.maxFileSize=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this._scale},set:function(t){this.setScale(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minScale",{get:function(){return this._minScale},enumerable:!0,configurable:!0}),t.prototype.ngOnDestroy=function(){this._listeners.forEach(function(t){return t.unsubscribe()}),this._listeners.clear()},t.prototype._imgLoaded=function(t){if(t){this._img=t;var e=this._imgCanvas.nativeElement;e.width=t.width,e.height=t.height;var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height),i.drawImage(t,0,0),this._minScale=_(this.config.width,this.config.height,e.width,e.height)}},t.prototype._setStylesForContImg=function(t){var e={},i=this._rootRect();if(void 0!==t.x&&void 0!==t.y){var n=i.width/2-t.x,r=i.height/2-t.y;this._imgRect.x=t.x,this._imgRect.y=t.y,this._imgRect.xc=n,this._imgRect.yc=r}for(var o in e.transform="translate3d("+this._imgRect.x+"px,"+this._imgRect.y+"px, 0)",e.transform+="scale("+this._scal3Fix+")",e.transformOrigin=this._imgRect.xc+"px "+this._imgRect.yc+"px 0",e)e.hasOwnProperty(o)&&this._renderer.setStyle(this._imgContainer.nativeElement,o,e[o])},t.prototype._resize$=function(){this.isLoaded&&this.updatePosition()},t.prototype.selectInputEvent=function(t){var i=this,n=t.target;if(!n.files||1===n.files.length){var e=n.files[0].size,r=n.value.replace(/.*(\/|\\)/,"");if(this.maxFileSize&&e>this.maxFileSize){var o={name:r,type:n.files[0].type,size:e,error:p.Size};return this.clean(),void this.error.emit(o)}var s=new FileReader,a=g.fromEvent(s,"load").pipe(l.take(1)).subscribe(function(t){var e=t.target.result;i.config.type||(i._defaultType=n.files[0].type),i._fileName=r,i._sizeInBytes=n.files[0].size,i.setImageUrl(e),i.cd.markForCheck(),i._listeners["delete"](a)});this._listeners.add(a),s.readAsDataURL(n.files[0])}},t.prototype.setScale=function(t,e){var i=t>=this.minScale&&t<=1?t:this.minScale,n=null!=t&&t!==this.scale&&i!==this.scale;if(this._scale=t,n){if(this._scal3Fix=i,this.isLoaded){if(!n)return;var r=u({},this._imgRect);this.offset={x:r.x,y:r.y,left:r.xc,top:r.yc},this._setStylesForContImg({}),this._move({srcEvent:{},deltaX:0,deltaY:0})}else{if(!this.minScale)return;this._setStylesForContImg(u({},this._getCenterPoints()))}this.scaleChange.emit(t),e||this._cropIfAutoCrop()}},t.prototype._getCenterPoints=function(){var t=this.elementRef.nativeElement,e=this._imgCanvas.nativeElement;return{x:(t.offsetWidth-e.width)/2,y:(t.offsetHeight-e.height)/2}},t.prototype.fitToScreen=function(){var t=this.elementRef.nativeElement,e=t.offsetWidth,i=t.offsetHeight,n=this._img,r={width:e/n.width,height:i/n.height},o=Math.max(r.width,r.height);this.setScale(o)},t.prototype.fit=function(){this.setScale(this.minScale)},t.prototype._moveStart=function(){this.offset={x:this._imgRect.x,y:this._imgRect.y,left:this._imgRect.xc,top:this._imgRect.yc}},t.prototype._move=function(t){var e,i,n=this._imgCanvas.nativeElement,r=this._scal3Fix,o=this.config,s=this.offset;r&&s&&(o.width/2/r>=s.left-t.deltaX/r&&(e=s.x+s.left-o.width/2/r),o.height/2/r>=s.top-t.deltaY/r&&(i=s.y+s.top-o.height/2/r),o.width/2/r+n.width-(s.left-t.deltaX/r)<=o.width/r&&(e=s.x+s.left+o.width/2/r-n.width),o.height/2/r+n.height-(s.top-t.deltaY/r)<=o.height/r&&(i=s.y+s.top+o.height/2/r-n.height),void 0===e&&(e=t.deltaX/r+s.x),void 0===i&&(i=t.deltaY/r+s.y),this._setStylesForContImg({x:e,y:i}))},t.prototype.updatePosition=function(t,e){var i=this._rootRect(),n=this._areaCropperRect();t===undefined&&e===undefined&&(t=this._imgRect.xc,e=this._imgRect.yc),t=n.x-i.x-(t-this.config.width/2),e=n.y-i.y-(e-this.config.height/2),this._setStylesForContImg({x:t,y:e})},t.prototype._slideEnd=function(){this._cropIfAutoCrop()},t.prototype._cropIfAutoCrop=function(){this.config.autoCrop&&this.crop()},t.prototype.zoomIn=function(){var t=this._scal3Fix+.05;0<t&&t<=1?this.setScale(t):this.setScale(1)},t.prototype.clean=function(){if(this.isLoaded){this._imgRect={},this.offset=undefined,this.scale=undefined,this._scal3Fix=undefined,this._rotation=0,this._minScale=undefined,this._isLoadedImg=!1,this.isLoaded=!1,this.isCropped=!1,this._originalImgBase64=undefined;var t=this._imgCanvas.nativeElement;t.width=0,t.height=0,this.cd.markForCheck()}},t.prototype.zoomOut=function(){var t=this._scal3Fix-.05;t>this.minScale&&t<=1?this.setScale(t):this.fit()},t.prototype.center=function(){var t=u({},this._getCenterPoints());this._setStylesForContImg(t),this._cropIfAutoCrop()},t.prototype.setImageUrl=function(t,e){var i=this;this.clean(),this._originalImgBase64=t;var n=new Image,r=this._sizeInBytes,o=this._fileName,s=this._defaultType;n.crossOrigin="anonymous";var a={name:o,type:s,originalDataURL:t};n.src=t,r&&(a.size=r);var h=g.fromEvent(n,"load").pipe(l.take(1)).subscribe(function(){i._imgLoaded(n),a.width=n.width,a.height=n.height,i._isLoadedImg=!0,i.cd.markForCheck(),i._ngZone.onStable.pipe(l.take(1)).subscribe(function(){return i._ngZone.run(function(){i.isLoaded=!1,e?e():i.setScale(i.minScale,!0),i.loaded.emit(a),i.isLoaded=!0,i._cropIfAutoCrop(),i.cd.markForCheck()})}),i._listeners["delete"](h),i.ngOnDestroy()});this._listeners.add(h);var c=g.fromEvent(n,"error").pipe(l.take(1)).subscribe(function(){a.error=p.Type,i.error.emit(a),i._listeners["delete"](c),i.ngOnDestroy()});this._listeners.add(c),this._sizeInBytes=null,this._fileName=null,this._defaultType=undefined},t.prototype.rotate=function(t){var e=this._rotation=function m(t){var e=y(y(t,360).result,90),i=Math.sign(t);return 45<=e.result?90*(e.parts+1)*i:90*e.parts*i}(t),i=e*Math.PI/180,n=this._imgCanvas.nativeElement,r=function f(t){var e=document.createElement("canvas"),i=e.getContext("2d");return e.width=t.width,e.height=t.height,i.drawImage(t,0,0),e}(n),o=n.getContext("2d");o.clearRect(0,0,r.width,r.height),this._renderer.setStyle(n,"transform","rotate("+e+"deg) scale("+1/this._scal3Fix+")"),this._renderer.setStyle(n,"transformOrigin",this._imgRect.xc+"px "+this._imgRect.yc+"px 0");var s=n.getBoundingClientRect(),a=s.x,h=s.y,c=n.getBoundingClientRect();this._renderer.removeStyle(n,"transform"),this._renderer.removeStyle(n,"transformOrigin");var l=c.width,g=c.height;o.canvas.width=l,o.canvas.height=g,o.clearRect(0,0,l,g),o.translate(l/2,g/2),o.rotate(i),o.drawImage(r,-r.width/2,-r.height/2),this._minScale=_(this.config.width,this.config.height,n.width,n.height),this.scale<this.minScale&&this.setScale(0,!0);var p=this._rootRect();this._setStylesForContImg({x:a-p.x,y:h-p.y});var d=u({},this._imgRect);this.offset={x:d.x,y:d.y,left:d.xc,top:d.yc},this._setStylesForContImg({}),this._move({srcEvent:{},deltaX:0,deltaY:0}),this._cropIfAutoCrop()},t.prototype.imageSmoothingQuality=function(t,e,i){var n=Math.ceil(Math.log(Math.max(t.width,t.height)/Math.max(e.width,e.height))/Math.log(2))-1;n=n<=0?0:n;var r=Array.from(Array(n).keys()),o=t.getContext("2d"),s=Math.pow(10*i,n)/Math.pow(10,n),a=this._defaultType;if(n){var h=t.width*i,c=t.height*i;"image/png"!==a&&"image/svg+xml"!==a||(o.globalCompositeOperation="copy"),r.forEach(function(){o.drawImage(t,0,0,h,c)})}var l=document.createElement("canvas"),g=l.getContext("2d");return l.width=e.width,l.height=e.height,g.drawImage(t,0,0,t.width*s,t.height*s,0,0,l.width,l.height),l},t.prototype.crop=function(t){var e=t?n.mergeDeep({},this.config||o,t):this.config,i=this._imgCrop(e);return this.cd.markForCheck(),i},t.prototype._imgCrop=function(t){var e=document.createElement("canvas"),i=this._imgRect,n=this._scal3Fix,r=i.xc-t.width/2/n,o=i.yc-t.height/2/n,s={width:t.width,height:t.height};e.width=s.width/n,e.height=s.height/n;var a=e.getContext("2d");t.fill&&(a.fillStyle=t.fill,a.fillRect(0,0,e.width,e.height)),a.drawImage(this._imgCanvas.nativeElement,-r,-o);var h=e,c=t.antiAliased?.5:1;0===t.output?h=this.imageSmoothingQuality(h,s,c):"object"==typeof t.output&&(h=this.imageSmoothingQuality(h,t.output,c));var l={dataURL:t.type?h.toDataURL(""+t.type):h.toDataURL(this._defaultType),type:this._defaultType||t.type,name:this._fileName,width:s.width,height:s.height,originalDataURL:this._originalImgBase64,scale:this._scal3Fix,rotation:this._rotation,position:{x:this._imgRect.xc,y:this._imgRect.yc}};return this.isCropped=!0,this.cropped.emit(l),l},t.prototype._rootRect=function(){return this.elementRef.nativeElement.getBoundingClientRect()},t.prototype._areaCropperRect=function(){return this._croppingContainer.nativeElement.getBoundingClientRect()},t.decorators=[{type:s.Component,args:[{changeDetection:s.ChangeDetectionStrategy.OnPush,preserveWhitespaces:!1,selector:"ly-img-cropper, ly-cropping",template:'<div #_imgContainer\n[className]="classes.imgContainer"\n(slidestart)="_moveStart()"\n(slide)="_move($event)"\n(slideend)="_slideEnd()">\n  <canvas #_imgCanvas></canvas>\n</div>\n<div #_croppingContainer *ngIf="_isLoadedImg; else content" [className]="classes.area" [ngStyle]="{\n  width: config.width + \'px\',\n  height: config.height + \'px\'\n}"></div>\n<ng-template #content>\n  <div [className]="classes.defaultContent">\n    <input #_fileInput type="file" (change)="selectInputEvent($event)" accept="image/*">\n    <ng-content></ng-content>\n  </div>\n</ng-template>\n'}]}],t.ctorParameters=function(){return[{type:s.Renderer2},{type:n.LyTheme2},{type:s.ElementRef},{type:s.ChangeDetectorRef},{type:s.NgZone}]},t.propDecorators={_imgContainer:[{type:s.ViewChild,args:["_imgContainer"]}],_croppingContainer:[{type:s.ViewChild,args:["_croppingContainer"]}],_imgCanvas:[{type:s.ViewChild,args:["_imgCanvas"]}],config:[{type:s.Input}],scale:[{type:s.Input}],maxFileSize:[{type:s.Input}],scaleChange:[{type:s.Output}],loaded:[{type:s.Output}],cropped:[{type:s.Output}],error:[{type:s.Output}],_resize$:[{type:s.HostListener,args:["window:resize"]}]},t}();function y(t,e){var i,n=Math.abs(t),r=Math.floor(n/e);return i=r?n-e*r:t,n!==t&&(i*=-1),{result:i,parts:r}}function _(t,e,i,n){return Math.max(t/i,e/n)}var c=function(){function t(){}return t.decorators=[{type:s.NgModule,args:[{imports:[i.CommonModule],exports:[h],providers:[{provide:e.HAMMER_GESTURE_CONFIG,useClass:n.LyHammerGestureConfig}],declarations:[h]}]}],t}();t.ImgResolution=r,t.ImgCropperError=p,t.LyResizingCroppingImages=h,t.LyResizingCroppingImageModule=c,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=alyle-ui-resizing-cropping-images.umd.min.js.map