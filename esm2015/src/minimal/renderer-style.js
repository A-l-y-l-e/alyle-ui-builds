import * as tslib_1 from "tslib";
import { Injectable, ElementRef, Renderer2, Optional } from '@angular/core';
import { LyTheme2, ThemeRef } from '../theme/theme2.service';
import { TypeStyle } from '../theme/style';
const __CLASS_NAME__ = '__CLASS_NAME__';
let StyleRenderer = class StyleRenderer {
    constructor(_theme, _el, _renderer) {
        this._theme = _theme;
        this._renderer = _renderer;
        this._set = new Set();
        if (_el) {
            this._nEl = _el.nativeElement;
            this._set = new Set();
        }
    }
    /**
     * Build multiple styles and render them in the DOM.
     * @param styles Styles
     * @param applyRootClass If `applyToRoot` is `true` and the root property is defined,
     * it will automatically be added to the component.
     *
     * e.g.
     *
     * ```ts
     * const STYLES = () => ({
     *   root: lyl `{...}` // this class will be added to the root component
     * })
     * ```
     *
     */
    renderSheet(styles, applyRootClass) {
        const classes = this._theme._createStyleContent2(styles, null, null, TypeStyle.Multiple);
        if (applyRootClass && classes.root) {
            this.addClass(classes.root);
        }
        return classes;
    }
    /**
     * Render style and apply class name to host Component or Directive,
     * require provide `StyleRenderer` in your Component.
     * e.g.
     * @Component({
     *   ...
     *   providers: [ StyleRenderer ]
     * })
     */
    add(id, style, priority, oldClass) {
        const args = arguments;
        /** Class name or keyframe name */
        let className;
        let len = args.length;
        // clean
        if (len === 4 && args[3] == null) {
            len -= 1;
        }
        if (len === 3 && args[2] == null) {
            len -= 1;
        }
        if (len === 1) {
            className = this._theme._createStyleContent2(id, null, null, TypeStyle.LylStyle);
        }
        else if (len === 2) {
            if (typeof id === 'string') {
                className = this._theme._createStyleContent2(style, id, null, TypeStyle.LylStyle);
            }
            else if (typeof style === 'number') {
                className = this._theme._createStyleContent2(id, null, style, TypeStyle.LylStyle);
            }
            else {
                className = this._theme._createStyleContent2(id, null, null, TypeStyle.LylStyle);
                oldClass = style;
            }
        }
        else if (len === 3) {
            if (typeof id === 'string') {
                if (typeof priority === 'number') {
                    // (id, style, priority)
                    className = this._theme._createStyleContent2(style, id, priority, TypeStyle.LylStyle);
                }
                else {
                    // (id, style, oldClass)
                    className = this._theme._createStyleContent2(style, id, null, TypeStyle.LylStyle);
                    oldClass = priority;
                }
            }
            else {
                // (style, priority, oldClass)
                className = this._theme._createStyleContent2(id, null, style, TypeStyle.LylStyle);
                oldClass = priority;
            }
        }
        else if (len === 4) {
            className = this._theme._createStyleContent2(style, id, priority, TypeStyle.LylStyle);
        }
        if (this._nEl) {
            return this.updateClass(className, oldClass);
        }
        throw new Error(`StyleRenderer is required on the Component!\n`
            + `Add provider for StyleRenderer in Component or Directive:\n\n`
            + `e.g:\n\n`
            + `@Component({\n`
            + `  providers: [ StyleRenderer ]\n`
            + `})\n`);
    }
    /**
     * Only render style and return class name.
     */
    render(styleOrId, priorityOrStyle, priority) {
        if (typeof styleOrId === 'string') {
            return this._theme._createStyleContent2(priorityOrStyle, styleOrId, priority, TypeStyle.LylStyle);
        }
        return this._theme._createStyleContent2(styleOrId, null, priority, TypeStyle.LylStyle);
    }
    addClass(className) {
        if (!this._set.has(className)) {
            this._set.add(className);
            this._renderer.addClass(this._nEl, className);
        }
    }
    removeClass(className) {
        if (className && this._set.has(className)) {
            this._set.delete(className);
            this._renderer.removeClass(this._nEl, className);
        }
    }
    toggleClass(className, enabled) {
        if (enabled) {
            this.addClass(className);
        }
        else {
            this.removeClass(className);
        }
    }
    updateClass(newClassName, oldClassName) {
        this.removeClass(oldClassName);
        this.addClass(newClassName);
        return newClassName;
    }
};
StyleRenderer.ctorParameters = () => [
    { type: LyTheme2 },
    { type: ElementRef, decorators: [{ type: Optional }] },
    { type: Renderer2, decorators: [{ type: Optional }] }
];
StyleRenderer = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(1, Optional()),
    tslib_1.__param(2, Optional())
], StyleRenderer);
export { StyleRenderer };
/**
 * Parameter decorator to be used for create Dynamic style together with `@Input`
 * @param style style
 * @param priority priority of style
 * @decorator
 */
export function Style(style, priority) {
    return function (target, propertyKey, descriptor) {
        const index = `${__CLASS_NAME__}${propertyKey}`;
        if (descriptor) {
            const set = descriptor.set;
            descriptor.set = function (val) {
                const that = this;
                if (val == null) {
                    that.sRenderer.removeClass(that[index]);
                }
                else {
                    that[index] = that.sRenderer.add(`${getComponentName(that)}--${propertyKey}-${val}`, style(val, that), priority || that.$priority || that.constructor.$priority || 0, that[index]);
                }
                set.call(that, val);
            };
        }
        else {
            Object.defineProperty(target, propertyKey, {
                configurable: true,
                enumerable: true,
                set(val) {
                    const that = this;
                    if (val == null) {
                        that.sRenderer.removeClass(that[index]);
                    }
                    else {
                        that[`_${propertyKey}`] = val;
                        that[index] = that.sRenderer.add(`${getComponentName(that)}--${propertyKey}-${val}`, style(val, that), priority || that.$priority || that.constructor.$priority || 0, that[index]);
                    }
                },
                get() {
                    return this[`_${propertyKey}`];
                }
            });
        }
    };
}
function getComponentName(comp) {
    return comp.constructor.Ð¸ || comp.constructor.name || 'unnamed';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXItc3R5bGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWx5bGUvdWkvIiwic291cmNlcyI6WyJzcmMvbWluaW1hbC9yZW5kZXJlci1zdHlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RSxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTdELE9BQU8sRUFBRSxTQUFTLEVBQXVCLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEUsTUFBTSxjQUFjLEdBQUcsZ0JBQWdCLENBQUM7QUFHeEMsSUFBYSxhQUFhLEdBQTFCLE1BQWEsYUFBYTtJQUl4QixZQUNVLE1BQWdCLEVBQ1osR0FBZSxFQUNQLFNBQW9CO1FBRmhDLFdBQU0sR0FBTixNQUFNLENBQVU7UUFFSixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBTnpCLFNBQUksR0FBZ0IsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQVFyRCxJQUFJLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQztZQUM5QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7U0FDL0I7SUFDSCxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7O09BY0c7SUFDSCxXQUFXLENBQUksTUFBb0IsRUFBRSxjQUF3QjtRQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN6RixJQUFJLGNBQWMsSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzdCO1FBQ0QsT0FBTyxPQUFP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QUMsSUFBSSxXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUNqQyxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDLENBQUM7QUFDSixDQUFDO0FBUUQsU0FBUyxnQkFBZ0IsQ0FBQyxJQUFTO0lBQ2pDLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDO0FBQ2xFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBFbGVtZW50UmVmLCBSZW5kZXJlcjIsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMeVRoZW1lMiwgVGhlbWVSZWYgfSBmcm9tICcuLi90aGVtZS90aGVtZTIuc2VydmljZSc7XG5pbXBvcnQgeyBTdHlsZVRlbXBsYXRlIH0gZnJvbSAnLi4vcGFyc2UnO1xuaW1wb3J0IHsgVHlwZVN0eWxlLCBMeVN0eWxlcywgTHlDbGFzc2VzIH0gZnJvbSAnLi4vdGhlbWUvc3R5bGUnO1xuXG5jb25zdCBfX0NMQVNTX05BTUVfXyA9ICdfX0NMQVNTX05BTUVfXyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTdHlsZVJlbmRlcmVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBfc2V0OiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICBwcml2YXRlIF9uRWw6IEhUTUxFbGVtZW50O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX3RoZW1lOiBMeVRoZW1lMixcbiAgICBAT3B0aW9uYWwoKSBfZWw6IEVsZW1lbnRSZWYsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMlxuICApIHtcbiAgICBpZiAoX2VsKSB7XG4gICAgICB0aGlzLl9uRWwgPSBfZWwubmF0aXZlRWxlbWVudDtcbiAgICAgIHRoaXMuX3NldCA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdWlsZCBtdWx0aXBsZSBzdHlsZXMgYW5kIHJlbmRlciB0aGVtIGluIHRoZSBET00uXG4gICAqIEBwYXJhbSBzdHlsZXMgU3R5bGVzXG4gICAqIEBwYXJhbSBhcHBseVJvb3RDbGFzcyBJZiBgYXBwbHlUb1Jvb3RgIGlzIGB0cnVlYCBhbmQgdGhlIHJvb3QgcHJvcGVydHkgaXMgZGVmaW5lZCxcbiAgICogaXQgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGFkZGVkIHRvIHRoZSBjb21wb25lbnQuXG4gICAqXG4gICAqIGUuZy5cbiAgICpcbiAgICogYGBgdHNcbiAgICogY29uc3QgU1RZTEVTID0gKCkgPT4gKHtcbiAgICogICByb290OiBseWwgYHsuLi59YCAvLyB0aGlzIGNsYXNzIHdpbGwgYmUgYWRkZWQgdG8gdGhlIHJvb3QgY29tcG9uZW50XG4gICAqIH0pXG4gICAqIGBgYFxuICAgKlxuICAgKi9cbiAgcmVuZGVyU2hlZXQ8VD4oc3R5bGVzOiBUICYgTHlTdHlsZXMsIGFwcGx5Um9vdENsYXNzPzogYm9vbGVhbik6IEx5Q2xhc3NlczxUPiB7XG4gICAgY29uc3QgY2xhc3NlcyA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHN0eWxlcywgbnVsbCwgbnVsbCwgVHlwZVN0eWxlLk11bHRpcGxlKTtcbiAgICBpZiAoYXBwbHlSb290Q2xhc3MgJiYgY2xhc3Nlcy5yb290KSB7XG4gICAgICB0aGlzLmFkZENsYXNzKGNsYXNzZXMucm9vdCk7XG4gICAgfVxuICAgIHJldHVybiBjbGFzc2VzO1xuICB9XG5cbiAgYWRkKFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZVxuICApOiBzdHJpbmc7XG4gIGFkZChcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgcHJpb3JpdHk6IG51bWJlclxuICApOiBzdHJpbmc7XG4gIGFkZChcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgb2xkQ2xhc3M6IHN0cmluZ1xuICApOiBzdHJpbmc7XG4gIGFkZChcbiAgICBpZDogc3RyaW5nLFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZVxuICApOiBzdHJpbmc7XG5cbiAgYWRkKFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBwcmlvcml0eTogbnVtYmVyLFxuICAgIG9sZENsYXNzOiBzdHJpbmcgfCBudWxsXG4gICk6IHN0cmluZztcbiAgYWRkKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIHByaW9yaXR5OiBudW1iZXJcbiAgKTogc3RyaW5nO1xuICBhZGQoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgb2xkQ2xhc3M6IHN0cmluZyB8IG51bGxcbiAgKTogc3RyaW5nO1xuXG4gIGFkZChcbiAgICBpZDogc3RyaW5nLFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBwcmlvcml0eTogbnVtYmVyLFxuICAgIG9sZENsYXNzOiBzdHJpbmcgfCBudWxsXG4gICk6IHN0cmluZztcblxuICAvKipcbiAgICogUmVuZGVyIHN0eWxlIGFuZCBhcHBseSBjbGFzcyBuYW1lIHRvIGhvc3QgQ29tcG9uZW50IG9yIERpcmVjdGl2ZSxcbiAgICogcmVxdWlyZSBwcm92aWRlIGBTdHlsZVJlbmRlcmVyYCBpbiB5b3VyIENvbXBvbmVudC5cbiAgICogZS5nLlxuICAgKiBAQ29tcG9uZW50KHtcbiAgICogICAuLi5cbiAgICogICBwcm92aWRlcnM6IFsgU3R5bGVSZW5kZXJlciBdXG4gICAqIH0pXG4gICAqL1xuICBhZGQoXG4gICAgaWQ6IHN0cmluZyB8ICgodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSksXG4gICAgc3R5bGU/OiAoKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUpIHwgbnVtYmVyIHwgc3RyaW5nLFxuICAgIHByaW9yaXR5PzogbnVtYmVyIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCxcbiAgICBvbGRDbGFzcz86IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGxcbiAgKTogc3RyaW5nIHtcbiAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzO1xuICAgIC8qKiBDbGFzcyBuYW1lIG9yIGtleWZyYW1lIG5hbWUgKi9cbiAgICBsZXQgY2xhc3NOYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IGxlbiA9IGFyZ3MubGVuZ3RoO1xuXG4gICAgLy8gY2xlYW5cbiAgICBpZiAobGVuID09PSA0ICYmIGFyZ3NbM10gPT0gbnVsbCkge1xuICAgICAgbGVuIC09IDE7XG4gICAgfVxuICAgIGlmIChsZW4gPT09IDMgJiYgYXJnc1syXSA9PSBudWxsKSB7XG4gICAgICBsZW4gLT0gMTtcbiAgICB9XG5cbiAgICBpZiAobGVuID09PSAxKSB7XG4gICAgICBjbGFzc05hbWUgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihpZCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICB9IGVsc2UgaWYgKGxlbiA9PT0gMikge1xuICAgICAgaWYgKHR5cGVvZiBpZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoc3R5bGUgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgICAgaWQsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3R5bGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKGlkIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKGlkIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgICAgIG9sZENsYXNzID0gc3R5bGUgYXMgc3RyaW5nO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAobGVuID09PSAzKSB7XG4gICAgICBpZiAodHlwZW9mIGlkID09PSAnc3RyaW5nJykge1xuICAgICAgICBpZiAodHlwZW9mIHByaW9yaXR5ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgIC8vIChpZCwgc3R5bGUsIHByaW9yaXR5KVxuICAgICAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHN0eWxlIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICAgIGlkLFxuICAgICAgICAgIHByaW9yaXR5LFxuICAgICAgICAgIFR5cGVTdHlsZS5MeWxTdHlsZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gKGlkLCBzdHlsZSwgb2xkQ2xhc3MpXG4gICAgICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoc3R5bGUgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgICAgaWQsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgICAgIG9sZENsYXNzID0gcHJpb3JpdHk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIChzdHlsZSwgcHJpb3JpdHksIG9sZENsYXNzKVxuICAgICAgICBjbGFzc05hbWUgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihpZCBhcyAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICAgICAgICBudWxsLFxuICAgICAgICAgIHN0eWxlIGFzIG51bWJlcixcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgICBvbGRDbGFzcyA9IHByaW9yaXR5IGFzIHN0cmluZztcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGxlbiA9PT0gNCkge1xuICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoc3R5bGUgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgIGlkIGFzIHN0cmluZyxcbiAgICAgICAgcHJpb3JpdHkgYXMgbnVtYmVyLFxuICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fbkVsKSB7XG4gICAgICByZXR1cm4gdGhpcy51cGRhdGVDbGFzcyhjbGFzc05hbWUhLCBvbGRDbGFzcyk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBTdHlsZVJlbmRlcmVyIGlzIHJlcXVpcmVkIG9uIHRoZSBDb21wb25lbnQhXFxuYFxuICAgICAgKyBgQWRkIHByb3ZpZGVyIGZvciBTdHlsZVJlbmRlcmVyIGluIENvbXBvbmVudCBvciBEaXJlY3RpdmU6XFxuXFxuYFxuICAgICAgKyBgZS5nOlxcblxcbmBcbiAgICAgICsgYEBDb21wb25lbnQoe1xcbmBcbiAgICAgICsgYCAgcHJvdmlkZXJzOiBbIFN0eWxlUmVuZGVyZXIgXVxcbmBcbiAgICAgICsgYH0pXFxuYFxuICAgICk7XG4gIH1cblxuICByZW5kZXIoXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlXG4gICk6IHN0cmluZztcbiAgcmVuZGVyKFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBwcmlvcml0eTogbnVtYmVyXG4gICk6IHN0cmluZztcbiAgcmVuZGVyKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlXG4gICk6IHN0cmluZztcbiAgcmVuZGVyKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIHByaW9yaXR5OiBudW1iZXJcbiAgKTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBPbmx5IHJlbmRlciBzdHlsZSBhbmQgcmV0dXJuIGNsYXNzIG5hbWUuXG4gICAqL1xuICByZW5kZXIoXG4gICAgc3R5bGVPcklkOiBzdHJpbmcgfCAoKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUpLFxuICAgIHByaW9yaXR5T3JTdHlsZT86ICgodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSkgfCBudW1iZXIgfCBzdHJpbmcsXG4gICAgcHJpb3JpdHk/OiBudW1iZXIgfCB1bmRlZmluZWQgfCBudWxsXG4gICk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGVvZiBzdHlsZU9ySWQgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIocHJpb3JpdHlPclN0eWxlIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICBzdHlsZU9ySWQsXG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoc3R5bGVPcklkLFxuICAgICAgbnVsbCxcbiAgICAgIHByaW9yaXR5LFxuICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgfVxuXG4gIGFkZENsYXNzKGNsYXNzTmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLl9zZXQuaGFzKGNsYXNzTmFtZSkpIHtcbiAgICAgIHRoaXMuX3NldC5hZGQoY2xhc3NOYW1lKTtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHRoaXMuX25FbCwgY2xhc3NOYW1lKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVDbGFzcyhjbGFzc05hbWU/OiBzdHJpbmcgfCBudWxsKSB7XG4gICAgaWYgKGNsYXNzTmFtZSAmJiB0aGlzLl9zZXQuaGFzKGNsYXNzTmFtZSkpIHtcbiAgICAgIHRoaXMuX3NldC5kZWxldGUoY2xhc3NOYW1lKTtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuX25FbCwgY2xhc3NOYW1lKTtcbiAgICB9XG4gIH1cblxuICB0b2dnbGVDbGFzcyhjbGFzc05hbWU6IHN0cmluZywgZW5hYmxlZDogYm9vbGVhbikge1xuICAgIGlmIChlbmFibGVkKSB7XG4gICAgICB0aGlzLmFkZENsYXNzKGNsYXNzTmFtZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGVDbGFzcyhuZXdDbGFzc05hbWU6IHN0cmluZywgb2xkQ2xhc3NOYW1lOiBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5yZW1vdmVDbGFzcyhvbGRDbGFzc05hbWUpO1xuICAgIHRoaXMuYWRkQ2xhc3MobmV3Q2xhc3NOYW1lKTtcbiAgICByZXR1cm4gbmV3Q2xhc3NOYW1lO1xuICB9XG5cbn1cblxuLyoqXG4gKiBQYXJhbWV0ZXIgZGVjb3JhdG9yIHRvIGJlIHVzZWQgZm9yIGNyZWF0ZSBEeW5hbWljIHN0eWxlIHRvZ2V0aGVyIHdpdGggYEBJbnB1dGBcbiAqIEBwYXJhbSBzdHlsZSBzdHlsZVxuICogQHBhcmFtIHByaW9yaXR5IHByaW9yaXR5IG9mIHN0eWxlXG4gKiBAZGVjb3JhdG9yXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBTdHlsZTxJTlBVVCA9IGFueSwgQyA9IGFueT4oXG4gIHN0eWxlOiAodmFsOiBOb25OdWxsYWJsZTxJTlBVVD4sIGNvbXA6IEMpID0+ICgodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSksXG4gIHByaW9yaXR5PzogbnVtYmVyXG4pIHtcblxuICByZXR1cm4gZnVuY3Rpb24odGFyZ2V0OiBXaXRoU3R5bGVzLCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yPzogVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8SU5QVVQ+KSB7XG4gICAgY29uc3QgaW5kZXggPSBgJHtfX0NMQVNTX05BTUVfX30ke3Byb3BlcnR5S2V5fWA7XG4gICAgaWYgKGRlc2NyaXB0b3IpIHtcbiAgICAgIGNvbnN0IHNldCA9IGRlc2NyaXB0b3Iuc2V0ITtcbiAgICAgIGRlc2NyaXB0b3Iuc2V0ID0gZnVuY3Rpb24gKHZhbDogSU5QVVQpIHtcbiAgICAgICAgY29uc3QgdGhhdDogV2l0aFN0eWxlcyA9IHRoaXM7XG4gICAgICAgIGlmICh2YWwgPT0gbnVsbCkge1xuICAgICAgICAgIHRoYXQuc1JlbmRlcmVyLnJlbW92ZUNsYXNzKHRoYXRbaW5kZXhdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGF0W2luZGV4XSA9IHRoYXQuc1JlbmRlcmVyLmFkZChcbiAgICAgICAgICAgIGAke2dldENvbXBvbmVudE5hbWUodGhhdCl9LS0ke3Byb3BlcnR5S2V5fS0ke3ZhbH1gLFxuICAgICAgICAgICAgc3R5bGUodmFsIGFzIGFueSwgdGhhdCBhcyBhbnkpLFxuICAgICAgICAgICAgcHJpb3JpdHkgfHwgdGhhdC4kcHJpb3JpdHkgfHwgKHRoYXQuY29uc3RydWN0b3IgYXMgYW55KS4kcHJpb3JpdHkgfHwgMCxcbiAgICAgICAgICAgIHRoYXRbaW5kZXhdXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBzZXQuY2FsbCh0aGF0LCB2YWwpO1xuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgcHJvcGVydHlLZXksIHtcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICBzZXQodmFsOiBJTlBVVCkge1xuICAgICAgICAgIGNvbnN0IHRoYXQ6IFdpdGhTdHlsZXMgPSB0aGlzO1xuICAgICAgICAgIGlmICh2YWwgPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhhdC5zUmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhhdFtpbmRleF0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGF0W2BfJHtwcm9wZXJ0eUtleX1gXSA9IHZhbDtcbiAgICAgICAgICAgIHRoYXRbaW5kZXhdID0gdGhhdC5zUmVuZGVyZXIuYWRkKFxuICAgICAgICAgICAgICBgJHtnZXRDb21wb25lbnROYW1lKHRoYXQpfS0tJHtwcm9wZXJ0eUtleX0tJHt2YWx9YCxcbiAgICAgICAgICAgICAgc3R5bGUodmFsIGFzIE5vbk51bGxhYmxlPElOUFVUPiwgdGhhdCBhcyBhbnkpLFxuICAgICAgICAgICAgICBwcmlvcml0eSB8fCB0aGF0LiRwcmlvcml0eSB8fCAodGhhdC5jb25zdHJ1Y3RvciBhcyBhbnkpLiRwcmlvcml0eSB8fCAwLFxuICAgICAgICAgICAgICB0aGF0W2luZGV4XVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGdldCgpIHtcbiAgICAgICAgICByZXR1cm4gdGhpc1tgXyR7cHJvcGVydHlLZXl9YF07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXaXRoU3R5bGVzIHtcbiAgLyoqIFN0eWxlIFByaW9yaXR5LCBkZWZhdWx0OiAwICovXG4gIHJlYWRvbmx5ICRwcmlvcml0eT86IG51bWJlcjtcbiAgcmVhZG9ubHkgc1JlbmRlcmVyOiBTdHlsZVJlbmRlcmVyO1xufVxuXG5mdW5jdGlvbiBnZXRDb21wb25lbnROYW1lKGNvbXA6IGFueSkge1xuICByZXR1cm4gY29tcC5jb25zdHJ1Y3Rvci7QuCB8fCBjb21wLmNvbnN0cnVjdG9yLm5hbWUgfHwgJ3VubmFtZWQnO1xufVxuIl19