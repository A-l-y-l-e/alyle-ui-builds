import { Color } from '@alyle/ui/color';
import { shadowBuilder } from '../shadow';
import { getNativeElement } from '../minimal/common';
const DEFAULT_VALUE = '';
const STYLE_PRIORITY = -1;
export function mixinStyleUpdater(base) {
    return class extends base {
        setAutoContrast() {
            this._autoContrast = true;
        }
        updateStyle(element) {
            const __bg = this._superHyperInternalPropertyBg;
            const __color = this._superHyperInternalPropertyColor === 'auto'
                ? ''
                : this._superHyperInternalPropertyColor;
            const __raised = this._superHyperInternalPropertyRaised;
            const __elevation = this._superHyperInternalPropertyElevation;
            const __disabled = this._superHyperInternalPropertyDisabled;
            const __outlined = this._superHyperInternalPropertyOutlined;
            const __shadowColor = this._superHyperInternalPropertyShadowColor;
            const __isContrast = this._autoContrast || this._superHyperInternalPropertyColor === 'auto';
            const el = getNativeElement(element);
            const newKey = `c--${__bg || DEFAULT_VALUE}_${__color || DEFAULT_VALUE}_${__raised || DEFAULT_VALUE}_${__elevation || DEFAULT_VALUE}_${__disabled || DEFAULT_VALUE}_${__outlined || DEFAULT_VALUE}_${__shadowColor || DEFAULT_VALUE}_${__isContrast || DEFAULT_VALUE}`;
            const newClass = this._theme.renderStyle(newKey, (theme) => {
                let sColor;
                let sBackground;
                let sBorder;
                let sPointerEvents;
                let sBoxShadow;
                let sBoxShadowActive;
                if (__outlined) {
                    sBorder = '1px solid currentColor';
                }
                if (__disabled) {
                    sColor = theme.disabled.contrast;
                    sPointerEvents = 'none';
                    if (__bg) {
                        sBackground = theme.disabled.default;
                    }
                }
                else {
                    if (__bg) {
                        sBackground = colorOf(theme, __bg);
                        if (__isContrast && !__color) {
                            sColor = theme.colorOf(`${__bg}:contrast`);
                            // Generate auto contrast if is necessary
                            if (sColor.css().includes('invalid')) {
                                const lum = (__bg instanceof Color ? __bg : theme.colorOf(__bg)).luminance();
                                sColor = lum < 0.5 ? theme.text.light : theme.text.dark;
                            }
                        }
                    }
                    if (!sColor && __color) {
                        sColor = colorOf(theme, __color);
                    }
                    if (__raised || (__elevation != null)) {
                        if (!__bg) {
                            sBackground = theme.background.primary.default;
                        }
                        const backgroundColorCss = sBackground !== __bg && colorOf(theme, __bg || 'background:primary', 'shadow');
                        const shadowColor = (__shadowColor && colorOf(theme, __shadowColor)) || backgroundColorCss || sBackground || sColor || theme.shadow;
                        if (__elevation != null) {
                            sBoxShadow = shadowBuilder(__elevation, shadowColor);
                        }
                        else {
                            sBoxShadow = shadowBuilder(3, shadowColor);
                            sBoxShadowActive = shadowBuilder(8, shadowColor);
                        }
                    }
                }
                return (className) => `${className}{${sColor ? 'color:' + sColor : ''};${sBackground ? 'background:' + sBackground : ''};${sBorder ? 'border:' + sBorder : ''};${sPointerEvents ? 'pointer-events:' + sPointerEvents : ''};${sBoxShadow ? 'box-shadow:' + sBoxShadow : ''};}${className}:active{${sBoxShadowActive ? 'box-shadow:' + sBoxShadowActive : ''};}`;
            }, STYLE_PRIORITY);
            el.classList.remove(this._classNameAnonymous);
            el.classList.add(newClass);
            this._classNameAnonymous = newClass;
        }
        constructor(...args) { super(...args); }
    };
}
function colorOf(theme, color, optional) {
    return color instanceof Color ? color : theme.colorOf(color, optional);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtY29tbW9uLWJlaGF2aW9ycy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbHlsZS91aS8iLCJzb3VyY2VzIjpbInNyYy9jb21tb24vYnVpbGQtY29tbW9uLWJlaGF2aW9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFeEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQVUxQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUtyRCxNQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7QUFDekIsTUFBTSxjQUFjLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFhMUIsTUFBTSxVQUFVLGlCQUFpQixDQUFnQyxJQUFPO0lBQ3RFLE9BQU8sS0FBTSxTQUFRLElBQUk7UUFHdkIsZUFBZTtZQUNiLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1FBQzVCLENBQUM7UUFDRCxXQUFXLENBQUMsT0FBc0M7WUFDaEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLDZCQUE2QixDQUFDO1lBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQ0FBZ0MsS0FBSyxNQUFNO2dCQUM5RCxDQUFDLENBQUMsRUFBRTtnQkFDSixDQUFDLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxDQUFDO1lBQzFDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQztZQUN4RCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsb0NBQW9DLENBQUM7WUFDOUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLG1DQUFtQyxDQUFDO1lBQzVELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQztZQUM1RCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsc0NBQXNDLENBQUM7WUFDbEUsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENB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QU8sS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztBQUN6RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29sb3IgfSBmcm9tICdAYWx5bGUvdWkvY29sb3InO1xuaW1wb3J0IHsgQ29uc3RydWN0b3IgfSBmcm9tICcuL2NvbnN0cnVjdG9yJztcbmltcG9ydCB7IHNoYWRvd0J1aWxkZXIgfSBmcm9tICcuLi9zaGFkb3cnO1xuaW1wb3J0IHsgQ2FuQ29sb3IgfSBmcm9tICcuL2NvbG9yJztcbmltcG9ydCB7IENhbkJnIH0gZnJvbSAnLi9iZyc7XG5pbXBvcnQgeyBDYW5EaXNhYmxlIH0gZnJvbSAnLi9kaXNhYmxlZCc7XG5pbXBvcnQgeyBDYW5SYWlzZWQgfSBmcm9tICcuL3JhaXNlZCc7XG5pbXBvcnQgeyBDYW5FbGV2YXRpb24gfSBmcm9tICcuL2VsZXZhdGlvbic7XG5pbXBvcnQgeyBDYW5PdXRsaW5lZCB9IGZyb20gJy4vb3V0bGluZWQnO1xuaW1wb3J0IHsgQ2FuU2hhZG93Q29sb3IgfSBmcm9tICcuL3NoYWRvdy1jb2xvcic7XG5pbXBvcnQgeyBMeVRoZW1lMiB9IGZyb20gJy4uL3RoZW1lL3RoZW1lMi5zZXJ2aWNlJztcbmltcG9ydCB7IEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGdldE5hdGl2ZUVsZW1lbnQgfSBmcm9tICcuLi9taW5pbWFsL2NvbW1vbic7XG5pbXBvcnQgeyBUaGVtZVZhcmlhYmxlcyB9IGZyb20gJy4uL3RoZW1lL3RoZW1lLWNvbmZpZyc7XG5pbXBvcnQge1xuICAgfSBmcm9tICcuLi9wYXJzZSc7XG5cbmNvbnN0IERFRkFVTFRfVkFMVUUgPSAnJztcbmNvbnN0IFNUWUxFX1BSSU9SSVRZID0gLTE7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWlyZVBhcmFtc1N0eWxlVXBkYXRlciB7XG4gIF90aGVtZTogTHlUaGVtZTI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FuU3R5bGVVcGRhdGVyIHtcbiAgX3RoZW1lOiBMeVRoZW1lMjtcbiAgdXBkYXRlU3R5bGU6IChlbGVtZW50OiBFbGVtZW50UmVmIHwgRWxlbWVudCkgPT4gdm9pZDtcbiAgc2V0QXV0b0NvbnRyYXN0OiAoKSA9PiB2b2lkO1xufVxuZXhwb3J0IHR5cGUgQ2FuU3R5bGVVcGRhdGVyQ3RvciA9IENvbnN0cnVjdG9yPFJlcXVpcmVQYXJhbXNTdHlsZVVwZGF0ZXIgJiBQYXJ0aWFsPENhbkNvbG9yICYgQ2FuQmcgJiBDYW5EaXNhYmxlICYgQ2FuUmFpc2VkICYgQ2FuRWxldmF0aW9uICYgQ2FuT3V0bGluZWQgJiBDYW5TaGFkb3dDb2xvcj4+O1xuXG5leHBvcnQgZnVuY3Rpb24gbWl4aW5TdHlsZVVwZGF0ZXI8VCBleHRlbmRzIENhblN0eWxlVXBkYXRlckN0b3I+KGJhc2U6IFQpOiBDb25zdHJ1Y3RvcjxDYW5TdHlsZVVwZGF0ZXI+ICYgVCB7XG4gIHJldHVybiBjbGFzcyBleHRlbmRzIGJhc2Uge1xuICAgIF9jbGFzc05hbWVBbm9ueW1vdXM6IHN0cmluZztcbiAgICBfYXV0b0NvbnRyYXN0OiBib29sZWFuO1xuICAgIHNldEF1dG9Db250cmFzdCgpIHtcbiAgICAgIHRoaXMuX2F1dG9Db250cmFzdCA9IHRydWU7XG4gICAgfVxuICAgIHVwZGF0ZVN0eWxlKGVsZW1lbnQ6IEVsZW1lbnRSZWY8YW55PiB8IEhUTUxFbGVtZW50KSB7XG4gICAgICBjb25zdCBfX2JnID0gdGhpcy5fc3VwZXJIeXBlckludGVybmFsUHJvcGVydHlCZztcbiAgICAgIGNvbnN0IF9fY29sb3IgPSB0aGlzLl9zdXBlckh5cGVySW50ZXJuYWxQcm9wZXJ0eUNvbG9yID09PSAnYXV0bydcbiAgICAgICAgPyAnJ1xuICAgICAgICA6IHRoaXMuX3N1cGVySHlwZXJJbnRlcm5hbFByb3BlcnR5Q29sb3I7XG4gICAgICBjb25zdCBfX3JhaXNlZCA9IHRoaXMuX3N1cGVySHlwZXJJbnRlcm5hbFByb3BlcnR5UmFpc2VkO1xuICAgICAgY29uc3QgX19lbGV2YXRpb24gPSB0aGlzLl9zdXBlckh5cGVySW50ZXJuYWxQcm9wZXJ0eUVsZXZhdGlvbjtcbiAgICAgIGNvbnN0IF9fZGlzYWJsZWQgPSB0aGlzLl9zdXBlckh5cGVySW50ZXJuYWxQcm9wZXJ0eURpc2FibGVkO1xuICAgICAgY29uc3QgX19vdXRsaW5lZCA9IHRoaXMuX3N1cGVySHlwZXJJbnRlcm5hbFByb3BlcnR5T3V0bGluZWQ7XG4gICAgICBjb25zdCBfX3NoYWRvd0NvbG9yID0gdGhpcy5fc3VwZXJIeXBlckludGVybmFsUHJvcGVydHlTaGFkb3dDb2xvcjtcbiAgICAgIGNvbnN0IF9faXNDb250cmFzdCA9IHRoaXMuX2F1dG9Db250cmFzdCB8fCB0aGlzLl9zdXBlckh5cGVySW50ZXJuYWxQcm9wZXJ0eUNvbG9yID09PSAnYXV0byc7XG4gICAgICBjb25zdCBlbCA9IGdldE5hdGl2ZUVsZW1lbnQoZWxlbWVudCk7XG5cbiAgICAgIGNvbnN0IG5ld0tleSA9IGBjLS0ke1xuICAgICAgICBfX2JnIHx8IERFRkFVTFRfVkFMVUV9XyR7XG4gICAgICAgICAgX19jb2xvciB8fCBERUZBVUxUX1ZBTFVFfV8ke1xuICAgICAgICAgICAgX19yYWlzZWQgfHwgREVGQVVMVF9WQUxVRX1fJHtcbiAgICAgICAgICAgICAgX19lbGV2YXRpb24gfHwgREVGQVVMVF9WQUxVRX1fJHtcbiAgICAgICAgICAgICAgICBfX2Rpc2FibGVkIHx8IERFRkFVTFRfVkFMVUV9XyR7XG4gICAgICAgICAgICAgICAgICBfX291dGxpbmVkIHx8IERFRkFVTFRfVkFMVUV9XyR7XG4gICAgICAgICAgICAgICAgICAgIF9fc2hhZG93Q29sb3IgfHwgREVGQVVMVF9WQUxVRX1fJHtcbiAgICAgICAgICAgICAgICAgICAgICBfX2lzQ29udHJhc3QgfHwgREVGQVVMVF9WQUxVRX1gO1xuICAgICAgY29uc3QgbmV3Q2xhc3MgPSB0aGlzLl90aGVtZS5yZW5kZXJTdHlsZShuZXdLZXksICh0aGVtZTogVGhlbWVWYXJpYWJsZXMpID0+IHtcbiAgICAgICAgbGV0IHNDb2xvcjogQ29sb3IgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzQmFja2dyb3VuZDogQ29sb3IgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzQm9yZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzUG9pbnRlckV2ZW50czogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgICBsZXQgc0JveFNoYWRvdzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgICBsZXQgc0JveFNoYWRvd0FjdGl2ZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgICAgIGlmIChfX291dGxpbmVkKSB7XG4gICAgICAgICAgc0JvcmRlciA9ICcxcHggc29saWQgY3VycmVudENvbG9yJztcbiAgICAgICAgfVxuICAgICAgICBpZiAoX19kaXNhYmxlZCkge1xuICAgICAgICAgIHNDb2xvciA9IHRoZW1lLmRpc2FibGVkLmNvbnRyYXN0O1xuICAgICAgICAgIHNQb2ludGVyRXZlbnRzID0gJ25vbmUnO1xuICAgICAgICAgIGlmIChfX2JnKSB7XG4gICAgICAgICAgICBzQmFja2dyb3VuZCA9IHRoZW1lLmRpc2FibGVkLmRlZmF1bHQ7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChfX2JnKSB7XG4gICAgICAgICAgICBzQmFja2dyb3VuZCA9IGNvbG9yT2YodGhlbWUsIF9fYmcpO1xuICAgICAgICAgICAgaWYgKF9faXNDb250cmFzdCAmJiAhX19jb2xvcikge1xuICAgICAgICAgICAgICBzQ29sb3IgPSB0aGVtZS5jb2xvck9mKGAke19fYmd9OmNvbnRyYXN0YCk7XG5cbiAgICAgICAgICAgICAgLy8gR2VuZXJhdGUgYXV0byBjb250cmFzdCBpZiBpcyBuZWNlc3NhcnlcbiAgICAgICAgICAgICAgaWYgKHNDb2xvci5jc3MoKS5pbmNsdWRlcygnaW52YWxpZCcpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbHVtID0gKF9fYmcgaW5zdGFuY2VvZiBDb2xvciA/IF9fYmcgOiB0aGVtZS5jb2xvck9mKF9fYmcpKS5sdW1pbmFuY2UoKTtcbiAgICAgICAgICAgICAgICBzQ29sb3IgPSBsdW0gPCAwLjUgPyB0aGVtZS50ZXh0LmxpZ2h0IDogdGhlbWUudGV4dC5kYXJrO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghc0NvbG9yICYmIF9fY29sb3IpIHtcbiAgICAgICAgICAgIHNDb2xvciA9IGNvbG9yT2YodGhlbWUsIF9fY29sb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoX19yYWlzZWQgfHwgKF9fZWxldmF0aW9uICE9IG51bGwpKSB7XG4gICAgICAgICAgICBpZiAoIV9fYmcpIHtcbiAgICAgICAgICAgICAgc0JhY2tncm91bmQgPSB0aGVtZS5iYWNrZ3JvdW5kLnByaW1hcnkuZGVmYXVsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGJhY2tncm91bmRDb2xvckNzcyA9IHNCYWNrZ3JvdW5kICE9PSBfX2JnICYmIGNvbG9yT2YodGhlbWUsIF9fYmcgfHwgJ2JhY2tncm91bmQ6cHJpbWFyeScsICdzaGFkb3cnKTtcbiAgICAgICAgICAgIGNvbnN0IHNoYWRvd0NvbG9yID0gKF9fc2hhZG93Q29sb3IgJiYgY29sb3JPZih0aGVtZSwgX19zaGFkb3dDb2xvcikpIHx8IGJhY2tncm91bmRDb2xvckNzcyB8fCBzQmFja2dyb3VuZCB8fCBzQ29sb3IgfHwgdGhlbWUuc2hhZG93O1xuICAgICAgICAgICAgaWYgKF9fZWxldmF0aW9uICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgc0JveFNoYWRvdyA9IHNoYWRvd0J1aWxkZXIoX19lbGV2YXRpb24sIHNoYWRvd0NvbG9yKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNCb3hTaGFkb3cgPSBzaGFkb3dCdWlsZGVyKDMsIHNoYWRvd0NvbG9yKTtcbiAgICAgICAgICAgICAgc0JveFNoYWRvd0FjdGl2ZSA9IHNoYWRvd0J1aWxkZXIoOCwgc2hhZG93Q29sb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKGNsYXNzTmFtZTogc3RyaW5nKSA9PiBgJHtjbGFzc05hbWV9eyR7c0NvbG9yID8gJ2NvbG9yOicgKyBzQ29sb3IgOiAnJ307JHtzQmFja2dyb3VuZCA/ICdiYWNrZ3JvdW5kOicgKyBzQmFja2dyb3VuZCA6ICcnfTske3NCb3JkZXIgPyAnYm9yZGVyOicgKyBzQm9yZGVyIDogJyd9OyR7c1BvaW50ZXJFdmVudHMgPyAncG9pbnRlci1ldmVudHM6JyArIHNQb2ludGVyRXZlbnRzIDogJyd9OyR7c0JveFNoYWRvdyA/ICdib3gtc2hhZG93OicgKyBzQm94U2hhZG93IDogJyd9O30ke2NsYXNzTmFtZX06YWN0aXZleyR7c0JveFNoYWRvd0FjdGl2ZSA/ICdib3gtc2hhZG93OicgKyBzQm94U2hhZG93QWN0aXZlIDogJyd9O31gO1xuICAgICAgfSwgU1RZTEVfUFJJT1JJVFkpO1xuXG4gICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKHRoaXMuX2NsYXNzTmFtZUFub255bW91cyk7XG4gICAgICBlbC5jbGFzc0xpc3QuYWRkKG5ld0NsYXNzKTtcbiAgICAgIHRoaXMuX2NsYXNzTmFtZUFub255bW91cyA9IG5ld0NsYXNzO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKC4uLmFyZ3M6IGFueVtdKSB7IHN1cGVyKC4uLmFyZ3MpOyB9XG4gIH07XG59XG5cbmZ1bmN0aW9uIGNvbG9yT2YodGhlbWU6IFRoZW1lVmFyaWFibGVzLCBjb2xvcjogc3RyaW5nIHwgbnVtYmVyIHwgQ29sb3IsIG9wdGlvbmFsPzogc3RyaW5nKSB7XG4gIHJldHVybiBjb2xvciBpbnN0YW5jZW9mIENvbG9yID8gY29sb3IgOiB0aGVtZS5jb2xvck9mKGNvbG9yLCBvcHRpb25hbCk7XG59XG4iXX0=